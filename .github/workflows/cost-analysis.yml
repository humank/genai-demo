name: AWS Cost Analysis

on:
  schedule:
    # Run daily at 2 AM UTC (10 AM Taiwan Time)
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      analysis_period:
        description: 'Analysis period in days'
        required: false
        default: '30'
        type: choice
        options:
          - '7'
          - '30'
          - '90'

permissions:
  id-token: write  # Required for OIDC
  contents: write  # Required to commit reports
  actions: read    # Required for workflow

jobs:
  cost-analysis:
    name: Analyze AWS Costs
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Full history for better reporting
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-northeast-1
          role-session-name: GitHubActions-CostAnalysis
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc
      
      - name: Verify AWS CLI access
        run: |
          echo "üîç Verifying AWS CLI access..."
          aws sts get-caller-identity
          aws ce describe-cost-category-definition --cost-category-arn "arn:aws:ce::${{ secrets.AWS_ACCOUNT_ID }}:costcategory/default" || echo "Cost Explorer access verified"
      
      - name: Run cost analysis
        id: analysis
        run: |
          echo "üìä Running cost analysis..."
          ./infrastructure/scripts/analyze-costs.sh
          
          # Capture summary for GitHub Actions output
          REPORT_FILE=$(ls -t reports/cost-analysis/cost-analysis-report-*.md | head -1)
          echo "report_file=$REPORT_FILE" >> $GITHUB_OUTPUT
          
          # Extract key metrics
          TOTAL_COST=$(grep "Total Cost (30 days)" "$REPORT_FILE" | grep -oP '\$\K[0-9.]+')
          TAIWAN_COST=$(grep "Taiwan Region Cost (7 days)" "$REPORT_FILE" | grep -oP '\$\K[0-9.]+')
          JAPAN_COST=$(grep "Japan DR Region Cost (7 days)" "$REPORT_FILE" | grep -oP '\$\K[0-9.]+')
          
          echo "total_cost=$TOTAL_COST" >> $GITHUB_OUTPUT
          echo "taiwan_cost=$TAIWAN_COST" >> $GITHUB_OUTPUT
          echo "japan_cost=$JAPAN_COST" >> $GITHUB_OUTPUT
      
      - name: Run MCP TCO Analysis
        id: tco_analysis
        run: |
          echo "üí∞ Running MCP TCO Analysis..."
          ./infrastructure/scripts/mcp-tco-calculator.sh
          
          # Capture TCO metrics
          TCO_REPORT=$(ls -t reports/cost-analysis/tco-analysis-*.md | head -1)
          echo "tco_report=$TCO_REPORT" >> $GITHUB_OUTPUT
          
          # Extract TCO metrics
          MONTHLY_TCO=$(grep "Monthly TCO:" "$TCO_REPORT" | grep -oP '\$\K[0-9.]+' || echo "0")
          ANNUAL_TCO=$(grep "Annual TCO:" "$TCO_REPORT" | grep -oP '\$\K[0-9.]+' || echo "0")
          
          echo "monthly_tco=$MONTHLY_TCO" >> $GITHUB_OUTPUT
          echo "annual_tco=$ANNUAL_TCO" >> $GITHUB_OUTPUT
      
      - name: Commit cost report
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          git add reports/cost-analysis/
          
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No changes to commit"
          else
            git commit -m "chore: update cost analysis report $(date +%Y-%m-%d)
            
            - Total Cost (30 days): \$${{ steps.analysis.outputs.total_cost }}
            - Taiwan Region (7 days): \$${{ steps.analysis.outputs.taiwan_cost }}
            - Japan Region (7 days): \$${{ steps.analysis.outputs.japan_cost }}
            
            Generated by: GitHub Actions
            Workflow: ${{ github.workflow }}
            Run: ${{ github.run_number }}"
            
            git push
            echo "‚úÖ Cost report committed and pushed"
          fi
      
      - name: Upload report artifact
        uses: actions/upload-artifact@v5
        with:
          name: cost-analysis-report-${{ github.run_number }}
          path: reports/cost-analysis/
          retention-days: 90
      
      - name: Create cost summary
        run: |
          cat << EOF > $GITHUB_STEP_SUMMARY
          # üí∞ AWS Cost Analysis Summary
          
          **Report Date**: $(date +%Y-%m-%d)
          **Analysis Period**: Last 30 days
          
          ## üìä Cost Overview
          
          | Metric | Amount (USD) |
          |--------|--------------|
          | Total Cost (30 days) | \$${{ steps.analysis.outputs.total_cost }} |
          | Taiwan Region (7 days) | \$${{ steps.analysis.outputs.taiwan_cost }} |
          | Japan DR Region (7 days) | \$${{ steps.analysis.outputs.japan_cost }} |
          
          ## üìà Budget Status
          
          - **Taiwan Region**: $(echo "scale=1; (${{ steps.analysis.outputs.taiwan_cost }} * 4.3 / 5000) * 100" | bc)% of \$5,000 budget
          - **Japan Region**: $(echo "scale=1; (${{ steps.analysis.outputs.japan_cost }} * 4.3 / 3000) * 100" | bc)% of \$3,000 budget
          
          ## üí∞ Total Cost of Ownership (TCO)
          
          | Period | TCO (USD) |
          |--------|-----------|
          | Monthly TCO | \${{ steps.tco_analysis.outputs.monthly_tco }} |
          | Annual TCO | \${{ steps.tco_analysis.outputs.annual_tco }} |
          
          ## üîó Resources
          
          - [Cost Analysis Report](${{ steps.analysis.outputs.report_file }})
          - [TCO Analysis Report](${{ steps.tco_analysis.outputs.tco_report }})
          - [AWS Cost Explorer](https://console.aws.amazon.com/cost-management/home#/cost-explorer)
          - [CloudWatch Dashboard](https://console.aws.amazon.com/cloudwatch/home?region=ap-northeast-1#dashboards:name=GenAIDemo-Cost-Management)
          
          ---
          
          *Generated by GitHub Actions ‚Ä¢ Workflow: ${{ github.workflow }} ‚Ä¢ Run: ${{ github.run_number }}*
          *TCO Analysis powered by MCP AWS Pricing Tools*
          EOF
      
      - name: Check budget thresholds
        id: budget_check
        run: |
          TAIWAN_MONTHLY=$(echo "scale=2; ${{ steps.analysis.outputs.taiwan_cost }} * 4.3" | bc)
          JAPAN_MONTHLY=$(echo "scale=2; ${{ steps.analysis.outputs.japan_cost }} * 4.3" | bc)
          
          TAIWAN_THRESHOLD=4000  # 80% of $5000
          JAPAN_THRESHOLD=2400   # 80% of $3000
          
          ALERT_NEEDED=false
          
          if (( $(echo "$TAIWAN_MONTHLY > $TAIWAN_THRESHOLD" | bc -l) )); then
            echo "‚ö†Ô∏è Taiwan region approaching budget threshold!"
            ALERT_NEEDED=true
          fi
          
          if (( $(echo "$JAPAN_MONTHLY > $JAPAN_THRESHOLD" | bc -l) )); then
            echo "‚ö†Ô∏è Japan region approaching budget threshold!"
            ALERT_NEEDED=true
          fi
          
          echo "alert_needed=$ALERT_NEEDED" >> $GITHUB_OUTPUT
      
      - name: Send Slack notification (if threshold exceeded)
        if: steps.budget_check.outputs.alert_needed == 'true'
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          payload: |
            {
              "text": "‚ö†Ô∏è AWS Cost Budget Alert",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "‚ö†Ô∏è AWS Cost Budget Alert"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Total Cost (30 days):*\n$${{ steps.analysis.outputs.total_cost }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Taiwan Region (7 days):*\n$${{ steps.analysis.outputs.taiwan_cost }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Japan Region (7 days):*\n$${{ steps.analysis.outputs.japan_cost }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "One or more regions are approaching budget thresholds. Please review the cost analysis report."
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Report"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "AWS Cost Explorer"
                      },
                      "url": "https://console.aws.amazon.com/cost-management/home#/cost-explorer"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # Optional: Compare with previous report
  cost-comparison:
    name: Compare with Previous Report
    runs-on: ubuntu-latest
    needs: cost-analysis
    if: github.event_name == 'schedule'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 2  # Need previous commit
      
      - name: Compare costs
        run: |
          CURRENT_REPORT=$(ls -t reports/cost-analysis/cost-analysis-report-*.md | head -1)
          PREVIOUS_REPORT=$(ls -t reports/cost-analysis/cost-analysis-report-*.md | head -2 | tail -1)
          
          if [ -f "$PREVIOUS_REPORT" ]; then
            echo "üìä Comparing with previous report..."
            
            CURRENT_TOTAL=$(grep "Total Cost (30 days)" "$CURRENT_REPORT" | grep -oP '\$\K[0-9.]+')
            PREVIOUS_TOTAL=$(grep "Total Cost (30 days)" "$PREVIOUS_REPORT" | grep -oP '\$\K[0-9.]+')
            
            DIFF=$(echo "scale=2; $CURRENT_TOTAL - $PREVIOUS_TOTAL" | bc)
            PERCENT=$(echo "scale=1; ($DIFF / $PREVIOUS_TOTAL) * 100" | bc)
            
            echo "Current: \$$CURRENT_TOTAL"
            echo "Previous: \$$PREVIOUS_TOTAL"
            echo "Difference: \$$DIFF ($PERCENT%)"
            
            if (( $(echo "$PERCENT > 10" | bc -l) )); then
              echo "‚ö†Ô∏è Cost increased by more than 10%!"
            fi
          else
            echo "‚ÑπÔ∏è No previous report found for comparison"
          fi
