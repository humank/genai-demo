name: Validate Documentation

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'docs/**/*.md'
      - 'docs/**/*.puml'
      - '.kiro/steering/**/*.md'
      - '.kiro/examples/**/*.md'
      - 'scripts/validate-*.sh'
      - 'scripts/validate-*.py'
      - 'scripts/check-*.sh'
      - 'scripts/check-*.js'
      - 'scripts/generate-diagrams.sh'
  push:
    branches: [ main, develop ]
    paths:
      - 'docs/**/*.md'
      - 'docs/**/*.puml'
      - '.kiro/steering/**/*.md'
      - '.kiro/examples/**/*.md'
      - 'scripts/validate-*.sh'
      - 'scripts/validate-*.py'
      - 'scripts/check-*.sh'
      - 'scripts/check-*.js'
      - 'scripts/generate-diagrams.sh'
  workflow_dispatch:
    inputs:
      check_external_links:
        description: 'Check external links (slower)'
        required: false
        default: 'false'
        type: boolean
      full_validation:
        description: 'Run full validation suite'
        required: false
        default: 'false'
        type: boolean

jobs:
  validate-diagrams:
    name: Validate Diagrams and Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
    
    - name: Setup Java
      uses: actions/setup-java@v5
      with:
        distribution: 'temurin'
        java-version: '11'
    
    - name: Cache PlantUML
      uses: actions/cache@v4
      with:
        path: plantuml.jar
        key: plantuml-${{ hashFiles('scripts/generate-diagrams.sh') }}
    
    - name: Make scripts executable
      run: |
        chmod +x scripts/validate-diagrams.sh
        chmod +x scripts/generate-diagrams.sh
    
    - name: Validate PlantUML syntax
      run: |
        echo "üîç Validating PlantUML syntax..."
        ./scripts/validate-diagrams.sh --check-syntax
    
    - name: Check diagram references
      run: |
        echo "üîó Checking diagram references in documentation..."
        ./scripts/validate-diagrams.sh --check-references
    
    - name: Check for missing diagrams
      run: |
        echo "üìä Checking for missing generated diagrams..."
        ./scripts/validate-diagrams.sh --check-missing
    
    - name: Generate missing diagrams
      run: |
        echo "üé® Generating any missing diagrams..."
        ./scripts/generate-diagrams.sh --format=png
    
    - name: Verify generation success
      run: |
        echo "‚úÖ Verifying all diagrams are generated..."
        ./scripts/validate-diagrams.sh --check-missing
    
    - name: Upload generated diagrams (if any)
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: generated-diagrams
        path: docs/diagrams/generated/
        retention-days: 7

  validate-documentation-structure:
    name: Validate Documentation Structure
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
    
    - name: Check documentation structure
      run: |
        echo "üìÅ Validating documentation structure..."
        
        # Check required directories exist
        required_dirs=(
          "docs/viewpoints"
          "docs/perspectives" 
          "docs/templates"
          "docs/diagrams/viewpoints"
          "docs/diagrams/mermaid"
          ".kiro/steering"
        )
        
        for dir in "${required_dirs[@]}"; do
          if [ ! -d "$dir" ]; then
            echo "‚ùå Missing required directory: $dir"
            exit 1
          else
            echo "‚úÖ Found: $dir"
          fi
        done
    
    - name: Check template consistency
      run: |
        echo "üìù Checking template files..."
        
        # Check if template files exist
        templates=(
          "docs/templates/viewpoint-template.md"
          "docs/templates/perspective-template.md"
          "docs/templates/adr-template.md"
        )
        
        for template in "${templates[@]}"; do
          if [ ! -f "$template" ]; then
            echo "‚ùå Missing template: $template"
            exit 1
          else
            echo "‚úÖ Found: $template"
          fi
        done
    
    - name: Check for broken internal links
      run: |
        echo "üîó Checking for broken internal links..."
        
        # Find all markdown files
        find docs -name "*.md" -type f | while read -r file; do
          echo "Checking: $file"
          
          # Extract internal links (relative paths)
          grep -o '\[.*\](\..*\.md)' "$file" 2>/dev/null | while read -r link; do
            # Extract the path part
            path=$(echo "$link" | sed 's/.*](\(.*\))/\1/')
            
            # Resolve relative path
            dir=$(dirname "$file")
            full_path="$dir/$path"
            
            # Normalize path
            normalized_path=$(realpath -m "$full_path" 2>/dev/null || echo "$full_path")
            
            # Check if file exists
            if [ ! -f "$normalized_path" ]; then
              echo "‚ùå Broken link in $file: $link -> $normalized_path"
              exit 1
            fi
          done
        done
        
        echo "‚úÖ All internal links are valid"

  lint-markdown:
    name: Lint Markdown Files
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
    
    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '18'
    
    - name: Install markdownlint
      run: npm install -g markdownlint-cli
    
    - name: Create markdownlint config
      run: |
        cat > .markdownlint.json << 'EOF'
        {
          "MD013": false,
          "MD033": false,
          "MD041": false,
          "MD001": false
        }
        EOF
    
    - name: Lint markdown files
      run: |
        echo "üìù Linting markdown files..."
        markdownlint docs/**/*.md .kiro/steering/**/*.md .kiro/examples/**/*.md --config .markdownlint.json

  validate-links:
    name: Validate Links
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
    
    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Make scripts executable
      run: chmod +x scripts/check-links-advanced.js
    
    - name: Validate internal links
      run: |
        echo "üîó Validating internal links..."
        node scripts/check-links-advanced.js --internal-only
    
    - name: Validate external links
      if: github.event.inputs.check_external_links == 'true' || github.event.inputs.full_validation == 'true'
      run: |
        echo "üîó Validating external links..."
        node scripts/check-links-advanced.js --external
    
    - name: Upload link validation report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: link-validation-report
        path: build/reports/links-*.json
        retention-days: 7

  validate-spelling:
    name: Validate Spelling and Grammar
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
    
    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '18'
    
    - name: Install cspell
      run: npm install -g cspell
    
    - name: Create cspell config
      run: |
        cat > .cspell.json << 'EOF'
        {
          "version": "0.2",
          "language": "en",
          "words": [
            "Kiro", "PlantUML", "Mermaid", "Hexagonal", "DDD", "BDD", "TDD",
            "Rozanski", "Woods", "ArchUnit", "JUnit", "Mockito", "AssertJ",
            "Cucumber", "Gherkin", "PostgreSQL", "Redis", "Kafka", "MSK",
            "CloudWatch", "Grafana", "OpenAPI", "Swagger", "JWT", "RBAC",
            "GDPR", "PCI-DSS", "WCAG", "SLO", "RTO", "RPO", "CDK", "EKS",
            "RDS", "ElastiCache", "VPC", "AZ", "IAM", "S3", "Lambda",
            "EventBridge", "SQS", "SNS", "CloudFormation", "Terraform",
            "GitHub", "GitLab", "Jira", "Confluence", "Slack", "Docker",
            "Kubernetes", "Helm", "Gradle", "Maven", "npm", "yarn", "pnpm",
            "TypeScript", "JavaScript", "React", "Next.js", "Angular",
            "shadcn", "Radix", "Tailwind", "CSS", "HTML", "JSON", "YAML",
            "XML", "CSV", "Markdown", "AsciiDoc", "reStructuredText",
            "IntelliJ", "IDEA", "VSCode", "Eclipse", "NetBeans",
            "macOS", "Linux", "Ubuntu", "Debian", "CentOS", "RHEL",
            "Postman", "Insomnia", "cURL", "HTTPie", "wget",
            "JaCoCo", "SonarQube", "Checkstyle", "PMD", "SpotBugs",
            "Allure", "TestNG", "Spock", "Groovy", "Kotlin", "Scala",
            "Flyway", "Liquibase", "Hibernate", "JPA", "JDBC", "SQL",
            "NoSQL", "MongoDB", "Cassandra", "DynamoDB", "Elasticsearch",
            "Kibana", "Logstash", "Prometheus", "Jaeger", "Zipkin",
            "OAuth", "OIDC", "SAML", "LDAP", "Active Directory",
            "CI/CD", "DevOps", "SRE", "Agile", "Scrum", "Kanban",
            "microservices", "monolith", "serverless", "containerization",
            "orchestration", "observability", "telemetry", "tracing"
          ],
          "ignorePaths": [
            "node_modules/**",
            "build/**",
            "target/**",
            "*.jar",
            "*.class",
            "*.log",
            ".git/**"
          ]
        }
        EOF
    
    - name: Run spell check
      run: |
        echo "üìù Running spell check..."
        cspell "docs/**/*.md" ".kiro/steering/**/*.md" ".kiro/examples/**/*.md" --config .cspell.json || echo "Spelling issues found"

  validate-template-compliance:
    name: Validate Template Compliance
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Check viewpoint documentation
      run: |
        echo "üìã Checking viewpoint documentation..."
        
        viewpoints=(
          "functional"
          "information"
          "concurrency"
          "development"
          "deployment"
          "operational"
          "context"
        )
        
        for viewpoint in "${viewpoints[@]}"; do
          if [ ! -f "docs/viewpoints/$viewpoint/overview.md" ]; then
            echo "‚ùå Missing overview for viewpoint: $viewpoint"
            exit 1
          else
            echo "‚úÖ Found overview for: $viewpoint"
          fi
        done
    
    - name: Check perspective documentation
      run: |
        echo "üìã Checking perspective documentation..."
        
        perspectives=(
          "security"
          "performance"
          "availability"
          "evolution"
          "accessibility"
          "development-resource"
          "internationalization"
          "location"
        )
        
        for perspective in "${perspectives[@]}"; do
          if [ ! -f "docs/perspectives/$perspective/overview.md" ]; then
            echo "‚ùå Missing overview for perspective: $perspective"
            exit 1
          else
            echo "‚úÖ Found overview for: $perspective"
          fi
        done
    
    - name: Check template files
      run: |
        echo "üìã Checking template files..."
        
        templates=(
          "docs/templates/viewpoint-template.md"
          "docs/templates/perspective-template.md"
          "docs/templates/adr-template.md"
          "docs/templates/runbook-template.md"
          "docs/templates/api-endpoint-template.md"
        )
        
        for template in "${templates[@]}"; do
          if [ ! -f "$template" ]; then
            echo "‚ùå Missing template: $template"
            exit 1
          else
            echo "‚úÖ Found template: $template"
          fi
        done

  validate-metadata:
    name: Validate Document Metadata
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyyaml
    
    - name: Make scripts executable
      run: chmod +x scripts/validate-metadata.py
    
    - name: Validate metadata
      run: |
        echo "üìã Validating document metadata..."
        python3 scripts/validate-metadata.py --verbose

  detect-outdated-content:
    name: Detect Outdated Content
    runs-on: ubuntu-latest
    if: github.event.inputs.full_validation == 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        fetch-depth: 0  # Need full history
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Make scripts executable
      run: chmod +x scripts/detect-outdated-content.py
    
    - name: Detect outdated documentation
      run: |
        echo "üîç Detecting outdated documentation..."
        python3 scripts/detect-outdated-content.py --verbose || echo "Outdated content detected"
    
    - name: Upload outdated content report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: outdated-content-report
        path: build/reports/outdated-content.json
        retention-days: 7

  comprehensive-quality-check:
    name: Comprehensive Quality Check
    runs-on: ubuntu-latest
    needs: [validate-diagrams, validate-documentation-structure, lint-markdown, validate-links, validate-template-compliance, validate-metadata]
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
    
    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        npm ci
        python -m pip install --upgrade pip
        pip install pyyaml
    
    - name: Make scripts executable
      run: chmod +x scripts/check-documentation-quality.sh
    
    - name: Run comprehensive quality check
      run: |
        echo "üìã Running comprehensive documentation quality check..."
        bash scripts/check-documentation-quality.sh || echo "Quality issues found"
    
    - name: Upload quality reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: documentation-quality-reports
        path: build/reports/documentation-quality/
        retention-days: 30
    
    - name: Generate validation summary
      if: always()
      run: |
        echo "## Documentation Validation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Check job statuses
        echo "### Job Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Diagram Validation: ${{ needs.validate-diagrams.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Structure Validation: ${{ needs.validate-documentation-structure.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Markdown Linting: ${{ needs.lint-markdown.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Link Validation: ${{ needs.validate-links.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Template Compliance: ${{ needs.validate-template-compliance.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Metadata Validation: ${{ needs.validate-metadata.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Overall status
        if [ "${{ needs.validate-diagrams.result }}" == "success" ] && \
           [ "${{ needs.validate-documentation-structure.result }}" == "success" ] && \
           [ "${{ needs.lint-markdown.result }}" == "success" ] && \
           [ "${{ needs.validate-links.result }}" == "success" ] && \
           [ "${{ needs.validate-template-compliance.result }}" == "success" ] && \
           [ "${{ needs.validate-metadata.result }}" == "success" ]; then
          echo "### ‚úÖ All Validations Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "### ‚ùå Some Validations Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the individual job logs for details." >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Fail if critical validations failed
      if: needs.validate-diagrams.result == 'failure' || needs.validate-documentation-structure.result == 'failure' || needs.validate-links.result == 'failure'
      run: |
        echo "‚ùå Critical validation failures detected"
        exit 1

  check-hook-status:
    name: Check Hook Status
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
    
    - name: Verify hook configuration
      run: |
        echo "üîß Checking hook configuration..."
        
        # Check if only essential hook exists
        hook_count=$(find .kiro/hooks -name "*.kiro.hook" | wc -l)
        
        if [ "$hook_count" -eq 1 ]; then
          echo "‚úÖ Correct number of hooks: $hook_count"
        else
          echo "‚ùå Expected 1 hook, found: $hook_count"
          echo "Existing hooks:"
          find .kiro/hooks -name "*.kiro.hook"
          exit 1
        fi
        
        # Check if the correct hook exists
        if [ -f ".kiro/hooks/diagram-auto-generation.kiro.hook" ]; then
          echo "‚úÖ Essential hook exists: diagram-auto-generation.kiro.hook"
        else
          echo "‚ùå Missing essential hook: diagram-auto-generation.kiro.hook"
          exit 1
        fi
        
        # Check if README is updated
        if grep -q "diagram-auto-generation.kiro.hook" .kiro/hooks/README.md; then
          echo "‚úÖ README mentions the correct hook"
        else
          echo "‚ùå README doesn't mention diagram-auto-generation.kiro.hook"
          exit 1
        fi
        
        echo "üéâ Hook configuration is correct!"
