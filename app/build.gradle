plugins {
    id 'java'
    id 'org.springframework.boot' version '3.5.8'
    id 'io.spring.dependency-management' version '1.1.7'
    id 'io.qameta.allure' version '3.0.1' // Allure æ’ä»¶
    id 'jacoco' // JaCoCo ä»£ç¢¼è¦†è“‹ç‡æ’ä»¶
    id 'org.sonarqube' version '4.4.1.3373' // SonarQube æ’ä»¶
}

group = 'solid.humank'
version = '0.0.1-SNAPSHOT'

java {
    sourceCompatibility = '21'
    toolchain {
        languageVersion = JavaLanguageVersion.of(21)
    }
}

configurations {
    compileOnly {
        extendsFrom annotationProcessor
    }
}

repositories {
    mavenCentral()
}

// Allure é…ç½®
allure {
    version = '2.22.1'
    useJUnit5 {
        version = '2.22.1'
    }
}

// å®šç¾© Allure çµæœç›®éŒ„
def allureResultsDir = layout.buildDirectory.dir('allure-results').get().asFile.absolutePath

// JaCoCo é…ç½®
jacoco {
    toolVersion = "0.8.12"
}

// JaCoCo æ¸¬è©¦å ±å‘Šé…ç½®
jacocoTestReport {
    dependsOn test

    reports {
        xml.required = true
        html.required = true
        csv.required = false
    }

    afterEvaluate {
        classDirectories.setFrom(files(classDirectories.files.collect {
            fileTree(dir: it, exclude: [
                '**/config/**',
                '**/dto/**',
                '**/entity/**',
                '**/exception/**',
                '**/Application.class'
            ])
        }))
    }
}

// JaCoCo è¦†è“‹ç‡é©—è­‰é…ç½®
jacocoTestCoverageVerification {
    dependsOn jacocoTestReport

    violationRules {
        rule {
            enabled = true
            element = 'CLASS'

            limit {
                counter = 'LINE'
                value = 'COVEREDRATIO'
                minimum = 0.80
            }

            limit {
                counter = 'BRANCH'
                value = 'COVEREDRATIO'
                minimum = 0.75
            }
        }

        rule {
            enabled = true
            element = 'PACKAGE'

            limit {
                counter = 'LINE'
                value = 'COVEREDRATIO'
                minimum = 0.80
            }
        }
    }

    afterEvaluate {
        classDirectories.setFrom(files(classDirectories.files.collect {
            fileTree(dir: it, exclude: [
                '**/config/**',
                '**/dto/**',
                '**/entity/**',
                '**/exception/**',
                '**/Application.class'
            ])
        }))
    }
}

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-web'
    // WebSocket support removed for simplicity
    // implementation 'org.springframework.boot:spring-boot-starter-websocket'
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter-validation'
    implementation 'org.springframework.boot:spring-boot-starter-actuator'
    implementation 'org.flywaydb:flyway-core'
    implementation 'com.h2database:h2'

    // PostgreSQL driver for production profile
    runtimeOnly 'org.postgresql:postgresql'

    // Kafka support removed for simplicity
    // implementation 'org.springframework.kafka:spring-kafka'
    // testImplementation 'org.springframework.kafka:spring-kafka-test'

    // AOP support for logging aspects
    implementation 'org.springframework.boot:spring-boot-starter-aop'

    // Resilience4j for circuit breaker pattern
    implementation 'io.github.resilience4j:resilience4j-spring-boot3:2.3.0'
    implementation 'io.github.resilience4j:resilience4j-circuitbreaker:2.3.0'
    implementation 'io.github.resilience4j:resilience4j-retry:2.3.0'

    // Micrometer for metrics collection
    implementation 'io.micrometer:micrometer-core'
    implementation 'io.micrometer:micrometer-registry-prometheus'
    implementation 'io.micrometer:micrometer-registry-cloudwatch2'
    implementation 'io.micrometer:micrometer-tracing-bridge-otel'

    // OpenTelemetry for distributed tracing
    // OpenTelemetry for distributed tracing
    implementation platform('io.opentelemetry:opentelemetry-bom:1.56.0')
    implementation 'io.opentelemetry:opentelemetry-api'
    implementation 'io.opentelemetry:opentelemetry-context'
    implementation 'io.opentelemetry:opentelemetry-sdk'
    implementation 'io.opentelemetry:opentelemetry-exporter-otlp'
    // Note: jaeger exporter is deprecated, use OTLP exporter instead
    implementation 'io.opentelemetry.semconv:opentelemetry-semconv:1.30.0'

    // AWS X-Ray support for production
    implementation('com.amazonaws:aws-xray-recorder-sdk-core:2.20.0') {
        exclude group: 'org.apache.httpcomponents', module: 'httpclient'
        exclude group: 'org.apache.httpcomponents', module: 'httpcore'
    }
    implementation('com.amazonaws:aws-xray-recorder-sdk-spring:2.20.0') {
        exclude group: 'org.apache.httpcomponents', module: 'httpclient'
        exclude group: 'org.apache.httpcomponents', module: 'httpcore'
    }

    // AWS SDK v2 for analytics and security
    implementation platform('software.amazon.awssdk:bom:2.38.7')
    implementation 'software.amazon.awssdk:firehose'
    implementation 'software.amazon.awssdk:secretsmanager'
    implementation 'software.amazon.awssdk:cloudwatch'
    implementation 'software.amazon.awssdk:dynamodb'
    implementation 'software.amazon.awssdk:dynamodb-enhanced'

    // Security dependencies
    implementation 'org.springframework.boot:spring-boot-starter-security'

    // Redis and Redisson for distributed locking
    implementation 'org.springframework.boot:spring-boot-starter-data-redis'
    // implementation 'org.redisson:redisson-spring-boot-starter:3.52.0'

    // Apache Commons Pool for Redis connection pooling
    implementation 'org.apache.commons:commons-pool2:2.12.1'

    // Unified HttpComponents5 dependencies with consistent versions
    implementation 'org.apache.httpcomponents.client5:httpclient5:5.5.1'
    implementation 'org.apache.httpcomponents.core5:httpcore5:5.3.6'
    implementation 'org.apache.httpcomponents.core5:httpcore5-h2:5.3.6'

    // Test-specific HTTP client dependencies
    testImplementation 'org.apache.httpcomponents.client5:httpclient5:5.5.1'
    testImplementation 'org.apache.httpcomponents.core5:httpcore5:5.3.6'
    testImplementation 'org.apache.httpcomponents.client5:httpclient5-fluent:5.5.1'

    // Logback encoder for structured logging
    implementation 'net.logstash.logback:logstash-logback-encoder:9.0'

    // OpenAPI 3 (Swagger) æ”¯æ´ - ä½¿ç”¨èˆ‡ Spring Boot 3.4.9 å…¼å®¹çš„ç‰ˆæœ¬
    implementation 'org.springdoc:springdoc-openapi-starter-webmvc-ui:2.8.14'

    // Kotlin reflection for SpringDoc (required by SpringDoc 2.x) - æ›´æ–°ç‰ˆæœ¬
    implementation 'org.jetbrains.kotlin:kotlin-reflect:2.2.21'



    // Cucumber for BDD testing - ä½¿ç”¨æœ€æ–°ç©©å®šç‰ˆæœ¬
    testImplementation 'io.cucumber:cucumber-java:7.32.0'
    testImplementation 'io.cucumber:cucumber-junit-platform-engine:7.32.0'
    testImplementation 'io.cucumber:cucumber-spring:7.32.0'

    // JUnit 5 - èˆ‡ Cucumber 7.20.1 å…¼å®¹çš„ç‰ˆæœ¬
    testImplementation(platform('org.junit:junit-bom:6.0.1'))
    testImplementation('org.junit.jupiter:junit-jupiter')
    testImplementation('org.junit.platform:junit-platform-suite')

    // ç¢ºä¿ JUnit Platform ç›¸é—œä¾è³´ç‰ˆæœ¬ä¸€è‡´ (èˆ‡ Cucumber 7.20.1 åŒ¹é…)
    testImplementation('org.junit.platform:junit-platform-commons:6.0.1')
    testImplementation('org.junit.platform:junit-platform-engine:6.0.1')

    // æ·»åŠ ç¼ºå¤±çš„ JUnit Platform æ”¯æ´é¡åˆ¥
    testImplementation('org.junit.platform:junit-platform-launcher:6.0.1')

    // Mockito
    testImplementation 'org.mockito:mockito-core:5.20.0'
    testImplementation 'org.mockito:mockito-junit-jupiter:5.20.0'
    testImplementation 'org.mockito:mockito-inline:5.2.0'

    // Spring Test
    testImplementation 'org.springframework.boot:spring-boot-starter-test'

    // Allure ä¾è³´
    testImplementation 'io.qameta.allure:allure-junit5:2.31.0'
    testImplementation 'io.qameta.allure:allure-cucumber7-jvm:2.31.0'
    testImplementation 'io.qameta.allure:allure-java-commons:2.31.0'

    // ArchUnit for architecture testing
    testImplementation 'com.tngtech.archunit:archunit-junit5:1.4.1'

    compileOnly 'org.projectlombok:lombok:1.18.42'
    annotationProcessor 'org.projectlombok:lombok:1.18.42'
    testCompileOnly 'org.projectlombok:lombok:1.18.42'
    testAnnotationProcessor 'org.projectlombok:lombok:1.18.42'
}

// é…ç½® Java ç·¨è­¯å’ŒåŸ·è¡Œä»»å‹™å•Ÿç”¨é è¦½åŠŸèƒ½
tasks.withType(JavaCompile).configureEach {
    options.compilerArgs += '--enable-preview'
    options.compilerArgs += '-Xlint:unchecked'
    // æš«æ™‚é—œé–‰æ£„ç”¨è­¦å‘Šï¼Œé¿å…éå¤šè¼¸å‡º
    // options.compilerArgs += '-Xlint:deprecation'
    options.release = 21

    // å¢åŠ ç·¨è­¯å™¨è¨˜æ†¶é«”
    options.forkOptions.jvmArgs += [
        '-Xmx3g',
        '-XX:MaxMetaspaceSize=1g',
        '-XX:+UseG1GC',
        '-XX:G1HeapRegionSize=32m'
    ]
    options.fork = true
}

tasks.withType(Test).configureEach {
    jvmArgs += '--enable-preview'

    // åŸºæœ¬è¨˜æ†¶é«”é…ç½®
    maxHeapSize = '4g'
    minHeapSize = '1g'

    // åŸºæœ¬JVMåƒæ•¸
    jvmArgs += [
        '-XX:MaxMetaspaceSize=1g',
        '-XX:+UseG1GC',
        '-Xshare:off'
    ]

    // æ¸¬è©¦åŸ·è¡Œé…ç½®
    maxParallelForks = 1
    forkEvery = 5

    // æ¸¬è©¦åŸ·è¡Œè¶…æ™‚é…ç½®
    timeout = Duration.ofMinutes(15)

    // åŸºæœ¬ç³»çµ±å±¬æ€§
    systemProperty 'spring.profiles.active', 'test'
    systemProperty 'logging.level.root', 'ERROR'
    systemProperty 'spring.jmx.enabled', 'false'
    systemProperty 'spring.main.lazy-initialization', 'true'
}

tasks.withType(JavaExec).configureEach {
    jvmArgs += '--enable-preview'
}

// ============================================================================
// åˆ†å±¤æ¸¬è©¦ä»»å‹™é…ç½® - éµå¾ªæ¸¬è©¦é‡‘å­—å¡”åŸå‰‡
// ============================================================================

// å¿«é€Ÿæ¸¬è©¦ä»»å‹™ - å³æ™‚åé¥‹ (< 2åˆ†é˜)
tasks.register('quickTest', Test) {
    description = 'Fast unit tests for immediate feedback during development (< 2 minutes)'
    group = 'verification'

    useJUnitPlatform {
        excludeTags 'integration', 'end-to-end', 'slow', 'external'
        includeTags 'unit', 'fast'
    }

    // å„ªåŒ–è¨˜æ†¶é«”é…ç½® - å¿«é€Ÿæ¸¬è©¦
    maxHeapSize = '1g'
    minHeapSize = '256m'

    // æœ€å¤§ä¸¦è¡ŒåŸ·è¡Œ
    maxParallelForks = Runtime.runtime.availableProcessors()
    forkEvery = 0  // ä¸é‡å•Ÿ JVM ä»¥æé«˜é€Ÿåº¦

    // æ•ˆèƒ½å„ªåŒ– JVM åƒæ•¸
    jvmArgs += [
        '-XX:+UseG1GC',
        '-XX:MaxGCPauseMillis=100',
        '-XX:+UseStringDeduplication',
        '-XX:G1HeapRegionSize=16m',
        '-Djunit.jupiter.execution.parallel.enabled=true',
        '-Djunit.jupiter.execution.parallel.mode.default=concurrent',
        '-Djunit.jupiter.execution.parallel.config.strategy=dynamic'
    ]

    // å¿«é€Ÿæ¸¬è©¦è¶…æ™‚è¨­å®š
    timeout = Duration.ofMinutes(2)

    testLogging {
        events "failed", "skipped"
        showStandardStreams = false
        exceptionFormat = 'short'
    }

    systemProperty 'spring.profiles.active', 'test'
    systemProperty 'logging.level.root', 'ERROR'
    systemProperty 'junit.jupiter.execution.timeout.default', '30s'
}

// å®Œæ•´å–®å…ƒæ¸¬è©¦ä»»å‹™ - æäº¤å‰é©—è­‰ (< 5åˆ†é˜)
tasks.register('unitTest', Test) {
    description = 'Comprehensive unit tests for pre-commit validation (< 5 minutes)'
    group = 'verification'

    useJUnitPlatform {
        excludeTags 'integration', 'slow'
        includeTags 'unit'
    }

    // å„ªåŒ–è¨˜æ†¶é«”é…ç½® - å–®å…ƒæ¸¬è©¦
    maxHeapSize = '2g'
    minHeapSize = '512m'

    // ä¸¦è¡ŒåŸ·è¡Œé…ç½®
    maxParallelForks = 2
    forkEvery = 0

    // æ•ˆèƒ½å„ªåŒ– JVM åƒæ•¸
    jvmArgs += [
        '-XX:+UseG1GC',
        '-XX:MaxGCPauseMillis=100',
        '-XX:+UseStringDeduplication',
        '-XX:G1HeapRegionSize=16m',
        '-Djunit.jupiter.execution.parallel.enabled=true'
    ]

    // å–®å…ƒæ¸¬è©¦è¶…æ™‚è¨­å®š
    timeout = Duration.ofMinutes(5)

    testLogging {
        events "passed", "failed", "skipped"
        showStandardStreams = false
        exceptionFormat = 'short'
    }

    systemProperty 'spring.profiles.active', 'test'
    systemProperty 'logging.level.root', 'ERROR'
    systemProperty 'junit.jupiter.execution.timeout.default', '1m'
}

// é›†æˆæ¸¬è©¦ä»»å‹™ - æäº¤å‰ä½¿ç”¨
tasks.register('integrationTest', Test) {
    description = 'Integration tests for pre-commit verification (~50MB, ~500ms each)'
    group = 'verification'

    useJUnitPlatform {
        includeTags 'integration'
        excludeTags 'end-to-end', 'slow'
    }

    // é›†æˆæ¸¬è©¦è¨˜æ†¶é«”é…ç½®
    maxHeapSize = '6g'
    minHeapSize = '2g'

    // ä¸²è¡ŒåŸ·è¡Œä»¥é¿å…è³‡æºç«¶çˆ­
    maxParallelForks = 1
    forkEvery = 5

    // é›†æˆæ¸¬è©¦ JVM å„ªåŒ–åƒæ•¸
    jvmArgs += [
        '-XX:MaxMetaspaceSize=1g',
        '-XX:+UseG1GC',
        '-XX:+UseStringDeduplication',
        '-XX:G1HeapRegionSize=32m',
        '-XX:+UnlockExperimentalVMOptions',
        '-XX:G1NewSizePercent=20',
        '-XX:G1MaxNewSizePercent=30',
        // HttpComponents å°ˆç”¨ JVM åƒæ•¸
        '-Dorg.apache.commons.logging.Log=org.apache.commons.logging.impl.SimpleLog',
        '-Dorg.apache.commons.logging.simplelog.showdatetime=true',
        '-Dorg.apache.commons.logging.simplelog.log.org.apache.http=DEBUG',
        '-Dorg.apache.http.wire=DEBUG',
        // ç¶²è·¯è¶…æ™‚é…ç½®
        '-Dsun.net.useExclusiveBind=false',
        '-Djava.net.preferIPv4Stack=true'
    ]

    // é›†æˆæ¸¬è©¦è¶…æ™‚è¨­å®š
    timeout = Duration.ofMinutes(30)

    testLogging {
        events "failed", "skipped"
        showStandardStreams = false
        exceptionFormat = 'short'
    }

    // é›†æˆæ¸¬è©¦ç³»çµ±å±¬æ€§
    systemProperty 'spring.profiles.active', 'test'
    systemProperty 'logging.level.root', 'ERROR'
    systemProperty 'junit.jupiter.execution.timeout.default', '2m'
    systemProperty 'http.client.connection.timeout', '10000'
    systemProperty 'http.client.socket.timeout', '30000'
    systemProperty 'test.resource.cleanup.enabled', 'true'
    systemProperty 'test.memory.monitoring.enabled', 'true'
}

// Staging æ¸¬è©¦ä»»å‹™ - å®Œæ•´é›†æˆæ¸¬è©¦åŸ·è¡Œ
tasks.register('stagingTest', Exec) {
    description = 'Run comprehensive staging integration tests'
    group = 'verification'

    workingDir file('../staging-tests')

    // æª¢æŸ¥ staging-tests ç›®éŒ„æ˜¯å¦å­˜åœ¨
    doFirst {
        if (!file('../staging-tests').exists()) {
            throw new GradleException('staging-tests directory not found. Please ensure staging test infrastructure is set up.')
        }
        if (!file('../staging-tests/scripts/run-integration-tests.sh').exists()) {
            throw new GradleException('run-integration-tests.sh script not found in staging-tests/scripts/')
        }
    }

    commandLine './scripts/run-integration-tests.sh'

    environment 'TEST_ENVIRONMENT', 'staging'
    environment 'JAVA_HOME', System.getProperty('java.home')

    // è¨­å®šè¶…æ™‚
    timeout = Duration.ofMinutes(45)

    // æ¨™æº–è¼¸å‡ºè™•ç†
    standardOutput = System.out
    errorOutput = System.err

    doLast {
        println "âœ… Staging integration tests completed successfully"
    }
}


// ç«¯åˆ°ç«¯æ¸¬è©¦ä»»å‹™ - ç™¼å¸ƒå‰ä½¿ç”¨
tasks.register('e2eTest', Test) {
    description = 'End-to-end tests for pre-release verification (~500MB, ~3s each)'
    group = 'verification'

    useJUnitPlatform {
        includeTags 'end-to-end'
    }

    // E2E æ¸¬è©¦è¨˜æ†¶é«”é…ç½®
    maxHeapSize = '8g'
    minHeapSize = '3g'

    // ä¸²è¡ŒåŸ·è¡Œä»¥ç¢ºä¿ç©©å®šæ€§
    maxParallelForks = 1
    forkEvery = 2

    // E2E æ¸¬è©¦å°ˆç”¨ JVM åƒæ•¸
    jvmArgs += [
        '-XX:MaxMetaspaceSize=2g',
        '-XX:+UseG1GC',
        '-XX:+UseStringDeduplication',
        '-XX:G1HeapRegionSize=32m',
        '-XX:+UnlockExperimentalVMOptions',
        '-XX:G1NewSizePercent=20',
        '-XX:G1MaxNewSizePercent=30',
        '-Djava.security.egd=file:/dev/./urandom'
    ]

    // E2E æ¸¬è©¦è¶…æ™‚è¨­å®š
    timeout = Duration.ofHours(1)

    testLogging {
        events "failed", "skipped", "passed"
        showStandardStreams = false
        exceptionFormat = 'full'
    }

    // E2E æ¸¬è©¦ç³»çµ±å±¬æ€§
    systemProperty 'spring.profiles.active', 'test'
    systemProperty 'logging.level.root', 'INFO'
    systemProperty 'junit.jupiter.execution.timeout.default', '5m'
    systemProperty 'spring.main.lazy-initialization', 'false'
    systemProperty 'http.client.connection.timeout', '30000'
    systemProperty 'http.client.socket.timeout', '60000'
    systemProperty 'test.performance.monitoring.enabled', 'true'
}

// æ¨™æº–æ¸¬è©¦ä»»å‹™ - ä¿æŒå‘å¾Œå…¼å®¹
tasks.named('test') {
    description = 'é‹è¡Œæ‰€æœ‰æ¸¬è©¦'

    useJUnitPlatform()

    maxHeapSize = '4g'
    minHeapSize = '1g'

    testLogging {
        events "failed"
        showStandardStreams = false
        exceptionFormat = 'short'
    }

    systemProperty 'spring.profiles.active', 'test'
    systemProperty 'logging.level.root', 'ERROR'
}

// Cucumber æ¸¬è©¦ä»»å‹™
tasks.register('cucumber', JavaExec) {
    dependsOn assemble, testClasses
    getMainClass().set("io.cucumber.core.cli.Main")
    classpath = configurations.testRuntimeClasspath + sourceSets.main.output + sourceSets.test.output

    maxHeapSize = '4g'
    jvmArgs += ['--enable-preview', '-Xshare:off']

    args = [
        '--plugin', 'progress',
        '--plugin', 'html:build/reports/cucumber/cucumber-report.html',
        '--plugin', 'json:build/reports/cucumber/cucumber-report.json',
        '--glue', 'solid.humank.genaidemo.bdd',
        'src/test/resources/features'
    ]

    systemProperty 'logging.level.root', 'ERROR'
}



// ============================================================================
// ä¾¿æ·çš„æ¸¬è©¦ä»»å‹™çµ„åˆ
// ============================================================================

// æäº¤å‰é©—è­‰
tasks.register('preCommitTest') {
    dependsOn unitTest, integrationTest
    description = 'æäº¤å‰æ¸¬è©¦ - åŒ…å«å–®å…ƒæ¸¬è©¦å’Œé›†æˆæ¸¬è©¦ (< 5åˆ†é˜)'
    group = 'verification'

    doLast {
        println "âœ… æäº¤å‰æ¸¬è©¦å®Œæˆ - å–®å…ƒæ¸¬è©¦å’Œé›†æˆæ¸¬è©¦é€šé"
    }
}

// å®Œæ•´é©—è­‰ - ç™¼å¸ƒå‰
tasks.register('fullTest') {
    dependsOn unitTest, integrationTest, e2eTest, cucumber
    description = 'å®Œæ•´æ¸¬è©¦ - ç™¼å¸ƒå‰ä½¿ç”¨ï¼ŒåŒ…å«æ‰€æœ‰æ¸¬è©¦é¡å‹'
    group = 'verification'

    doLast {
        println "âœ… å®Œæ•´æ¸¬è©¦å®Œæˆ - æ‰€æœ‰æ¸¬è©¦é€šé"
    }
}

// é‹è¡Œæ‰€æœ‰æ¸¬è©¦ä¸¦ç”Ÿæˆå ±å‘Šï¼ˆä¿æŒå‘å¾Œå…¼å®¹ï¼‰
tasks.register('runAllTests') {
    dependsOn test, cucumber, prepareAllureResults
    description = 'é‹è¡Œæ‰€æœ‰æ¸¬è©¦ä¸¦ç”Ÿæˆ Allure å ±å‘Šï¼ˆå‘å¾Œå…¼å®¹ï¼‰'
    group = 'verification'

    doLast {
        println "æ‰€æœ‰æ¸¬è©¦å·²å®Œæˆï¼ŒåŒ…æ‹¬å–®å…ƒæ¸¬è©¦å’Œ Cucumber æ¸¬è©¦"
    }

    finalizedBy 'allureReport', 'generatePerformanceReport'
}

// ç”Ÿæˆæ¸¬è©¦æ€§èƒ½å ±å‘Š
tasks.register('generatePerformanceReport', JavaExec) {
    description = 'Generate test performance reports with metrics and dashboards'
    group = 'reporting'

    dependsOn testClasses
    classpath = sourceSets.test.runtimeClasspath
    mainClass = 'solid.humank.genaidemo.testutils.TestPerformanceReportGenerator'

    // ç¢ºä¿å ±å‘Šç›®éŒ„å­˜åœ¨
    doFirst {
        mkdir "${buildDir}/reports/test-performance"
    }

    doLast {
        println "âœ… Test performance reports generated:"
        println "   - HTML Report: ${buildDir}/reports/test-performance/performance-report.html"
        println "   - CSV Data: ${buildDir}/reports/test-performance/performance-data.csv"
        println "   - Summary: ${buildDir}/reports/test-performance/overall-performance-summary.txt"
    }
}

// ç”Ÿæˆæ¸¬è©¦åŸ·è¡ŒæŒ‡æ¨™å’Œç›£æ§æ•¸æ“š
tasks.register('generateTestMetrics') {
    description = 'Generate test execution metrics and monitoring data for CI/CD dashboards'
    group = 'reporting'

    dependsOn test

    doLast {
        def metricsDir = file("${buildDir}/reports/metrics")
        metricsDir.mkdirs()

        def metricsFile = new File(metricsDir, "test-metrics.json")
        def testResults = file("${buildDir}/test-results/test")

        def totalTests = 0
        def passedTests = 0
        def failedTests = 0
        def skippedTests = 0

        if (testResults.exists()) {
            testResults.eachFileRecurse { file ->
                if (file.name.endsWith('.xml')) {
                    def xml = new XmlSlurper().parse(file)
                    totalTests += xml.@tests.toInteger()
                    failedTests += xml.@failures.toInteger()
                    skippedTests += xml.@skipped.toInteger()
                }
            }
            passedTests = totalTests - failedTests - skippedTests
        }

        def metrics = [
            timestamp: new Date().format("yyyy-MM-dd'T'HH:mm:ss'Z'"),
            totalTests: totalTests,
            passedTests: passedTests,
            failedTests: failedTests,
            skippedTests: skippedTests,
            successRate: totalTests > 0 ? (passedTests / totalTests * 100).round(2) : 0,
            buildNumber: System.getenv('BUILD_NUMBER') ?: 'local',
            branch: System.getenv('BRANCH_NAME') ?: 'unknown'
        ]

        metricsFile.text = groovy.json.JsonOutput.prettyPrint(groovy.json.JsonOutput.toJson(metrics))

        println "âœ… Test metrics generated: ${metricsFile.absolutePath}"
        println "   Total Tests: ${totalTests}"
        println "   Passed: ${passedTests}"
        println "   Failed: ${failedTests}"
        println "   Success Rate: ${metrics.successRate}%"
    }
}

// é‹è¡Œæ‰€æœ‰æ¸¬è©¦
tasks.register('runAllTestsComplete') {
    dependsOn test, cucumber, prepareAllureResults
    description = 'é‹è¡Œæ‰€æœ‰æ¸¬è©¦ä¸¦ç”Ÿæˆ Allure å ±å‘Š'
    group = 'verification'

    doLast {
        println "æ‰€æœ‰æ¸¬è©¦å·²å®Œæˆï¼ŒåŒ…æ‹¬å–®å…ƒæ¸¬è©¦ã€Cucumber æ¸¬è©¦å’Œæ€§èƒ½æ¸¬è©¦"
    }

    finalizedBy 'allureReport'
}

// é‹è¡Œæ‰€æœ‰æ¸¬è©¦ä¸¦å•Ÿå‹•å ±å‘Šæœå‹™å™¨
tasks.register('runAllTestsWithReport') {
    dependsOn 'runAllTests'
    description = 'é‹è¡Œæ‰€æœ‰æ¸¬è©¦ä¸¦å•Ÿå‹• Allure å ±å‘Šæœå‹™å™¨'
    group = 'verification'

    finalizedBy 'allureServe'
}

// æ¸…ç† Allure çµæœç›®éŒ„
tasks.register('cleanAllureResults', Delete) {
    delete(allureResultsDir)
    description = 'æ¸…ç† Allure çµæœç›®éŒ„'
    group = 'build'
}

// å‰µå»ºå †è½‰å„²ç›®éŒ„
tasks.register('createHeapDumpDir') {
    description = 'å‰µå»ºå †è½‰å„²ç›®éŒ„'
    group = 'build'

    doLast {
        mkdir "${buildDir}/reports/heap-dumps"
        println "å †è½‰å„²ç›®éŒ„å·²å‰µå»º: ${buildDir}/reports/heap-dumps"
    }
}

tasks.named('clean') {
    dependsOn 'cleanAllureResults'
}

// ç¢ºä¿æ¸¬è©¦ä»»å‹™å‰å‰µå»ºå¿…è¦ç›®éŒ„
tasks.withType(Test) {
    dependsOn 'createHeapDumpDir'
}

// æ‰‹å‹•è™•ç† Allure å ±å‘Šç”Ÿæˆï¼Œé¿å…ä½¿ç”¨å…§å»ºä»»å‹™
tasks.register('prepareAllureResults') {
    description = 'æº–å‚™ Allure å ±å‘Šæ•¸æ“š'
    group = 'reporting'

    doLast {
        // ç¢ºä¿ allure-results ç›®éŒ„å­˜åœ¨
        mkdir "${buildDir}/allure-results"

        // è¤‡è£½ Cucumber æ¸¬è©¦çµæœ
        copy {
            from "${buildDir}/reports/cucumber"
            into "${buildDir}/allure-results"
            include "**/*.json"
        }

        // è¤‡è£½ JUnit æ¸¬è©¦çµæœ
        copy {
            from "${buildDir}/test-results/test"
            into "${buildDir}/allure-results"
            include "**/*.xml"
        }

        // å‰µå»º executor.json æ–‡ä»¶
        def executorFile = new File("${buildDir}/allure-results/executor.json")
        executorFile.text = """{
            "name": "Gradle",
            "type": "gradle",
            "buildName": "GenAI Demo Project",
            "reportName": "DDD æ¶æ§‹æ¸¬è©¦å ±å‘Š"
        }"""

        println "Allure å ±å‘Šæ•¸æ“šæº–å‚™å®Œæˆï¼Œçµæœç›®éŒ„: ${buildDir}/allure-results"
    }
}

// è¦†è“‹ allureReport ä»»å‹™
tasks.named('allureReport') {
    dependsOn 'prepareAllureResults'
}

// ============================================================================
// SonarQube é…ç½® - ç¨‹å¼ç¢¼å“è³ªåˆ†æ
// ============================================================================

sonar {
    properties {
        // å°ˆæ¡ˆè­˜åˆ¥
        property "sonar.projectKey", "genai-demo"
        property "sonar.projectName", "GenAI Demo - E-Commerce Platform"
        property "sonar.projectVersion", "1.0.0"

        // æºç¢¼å’Œæ¸¬è©¦ç›®éŒ„
        property "sonar.sources", "src/main/java"
        property "sonar.tests", "src/test/java"

        // Java ç‰ˆæœ¬
        property "sonar.java.source", "21"
        property "sonar.java.target", "21"

        // ç·¨ç¢¼
        property "sonar.sourceEncoding", "UTF-8"

        // è¦†è“‹ç‡å ±å‘Šè·¯å¾‘
        property "sonar.coverage.jacoco.xmlReportPaths", "build/reports/jacoco/test/jacocoTestReport.xml"

        // æ’é™¤ä¸éœ€è¦åˆ†æçš„æª”æ¡ˆ
        property "sonar.exclusions", "**/config/**,**/dto/**,**/entity/**,**/exception/**,**/Application.java"

        // æ¸¬è©¦æ’é™¤
        property "sonar.test.exclusions", "**/test/**"

        // ============================================================================
        // å•é¡Œæ’é™¤é…ç½® - æ’é™¤èª¤å ±
        // ============================================================================

        property "sonar.issue.ignore.multicriteria", "e1,e2,e3,e4,e5"

        // E1: æ’é™¤ @Pointcut æ–¹æ³•çš„ç©ºæ–¹æ³•è­¦å‘Š
        property "sonar.issue.ignore.multicriteria.e1.ruleKey", "java:S1186"
        property "sonar.issue.ignore.multicriteria.e1.resourceKey", "**/*Aspect.java"

        // E2: æ’é™¤ AOP é…ç½®é¡çš„ç©ºæ–¹æ³•è­¦å‘Š
        property "sonar.issue.ignore.multicriteria.e2.ruleKey", "java:S1186"
        property "sonar.issue.ignore.multicriteria.e2.resourceKey", "**/*Config.java"

        // E3: æ’é™¤ Record é¡çš„ç©ºæ–¹æ³•è­¦å‘Šï¼ˆDTOï¼‰
        property "sonar.issue.ignore.multicriteria.e3.ruleKey", "java:S1186"
        property "sonar.issue.ignore.multicriteria.e3.resourceKey", "**/dto/**/*.java"

        // E4: æ’é™¤ Record é¡çš„ç©ºæ–¹æ³•è­¦å‘Šï¼ˆdomain value objectsï¼‰
        property "sonar.issue.ignore.multicriteria.e4.ruleKey", "java:S1186"
        property "sonar.issue.ignore.multicriteria.e4.resourceKey", "**/valueobject/**/*.java"

        // E5: æ’é™¤ Record é¡çš„ç©ºæ–¹æ³•è­¦å‘Šï¼ˆapplication DTOsï¼‰
        property "sonar.issue.ignore.multicriteria.e5.ruleKey", "java:S1186"
        property "sonar.issue.ignore.multicriteria.e5.resourceKey", "**/application/**/*Dto.java"

        // ============================================================================
        // å…¶ä»–å“è³ªè¦å‰‡é…ç½®
        // ============================================================================

        // é‡è¤‡å­—ä¸²é–¾å€¼ï¼ˆé è¨­ 3 æ¬¡ï¼Œæé«˜åˆ° 5 æ¬¡ï¼‰
        property "sonar.java.duplicatedBlocks.minimumLines", "5"

        // æ–¹æ³•é•·åº¦é™åˆ¶ï¼ˆé è¨­ 20 è¡Œï¼Œå…è¨± 30 è¡Œï¼‰
        property "sonar.java.maxMethodLines", "30"

        // åƒæ•¸æ•¸é‡é™åˆ¶ï¼ˆé è¨­ 7 å€‹ï¼Œå…è¨± 10 å€‹ï¼‰
        property "sonar.java.maxParameters", "10"
    }
}

// ç¢ºä¿ SonarQube åˆ†æå‰å…ˆåŸ·è¡Œæ¸¬è©¦å’Œè¦†è“‹ç‡å ±å‘Š
tasks.named('sonar') {
    dependsOn test, jacocoTestReport

    doFirst {
        println "ğŸ” é–‹å§‹ SonarQube ç¨‹å¼ç¢¼å“è³ªåˆ†æ..."
        println "   å°ˆæ¡ˆ: GenAI Demo - E-Commerce Platform"
        println "   ç‰ˆæœ¬: 1.0.0"
        println "   Java: 21"
    }

    doLast {
        println "âœ… SonarQube åˆ†æå®Œæˆï¼"
        println "   æŸ¥çœ‹å ±å‘Š: http://localhost:9000/dashboard?id=genai-demo"
    }
}
