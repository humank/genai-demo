# Test Profile Configuration
# This configuration ensures tests run in isolation with minimal dependencies

spring:
  # Application Configuration
  application:
    name: genai-demo
  
# Main configuration for tests - 優化記憶體使用
  main:
    allow-bean-definition-overriding: true
    lazy-initialization: true
    banner-mode: "off"  # 關閉啟動橫幅以減少輸出
  
  # Database Configuration - Use H2 in-memory for all tests
  datasource:
    url: jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE;MODE=PostgreSQL
    driver-class-name: org.h2.Driver
    username: sa
    password: ""
  
# JPA Configuration for Tests - 優化記憶體使用
  jpa:
    database-platform: org.hibernate.dialect.H2Dialect
    hibernate:
      ddl-auto: create-drop
    show-sql: false
    properties:
      hibernate:
        cache:
          use_second_level_cache: false
        format_sql: false
        generate_statistics: false
        use_sql_comments: false
        jdbc:
          batch_size: 20
          batch_versioned_data: true
        order_inserts: true
        order_updates: true
  
  # Disable Flyway for tests
  flyway:
    enabled: false
  
  # H2 Console - Disabled for security in tests
  h2:
    console:
      enabled: false
  
  # Kafka Configuration - Disabled for tests
  kafka:
    enabled: false
    bootstrap-servers: localhost:9092
    consumer:
      auto-offset-reset: earliest
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.apache.kafka.common.serialization.StringSerializer
  
  # Exclude unnecessary auto-configurations
  autoconfigure:
    exclude:
      - org.springframework.boot.autoconfigure.flyway.FlywayAutoConfiguration
      - org.springframework.boot.autoconfigure.kafka.KafkaAutoConfiguration
  
  # Disable scheduling for tests to prevent HealthMetricsCollector issues
  task:
    scheduling:
      enabled: false

# Logging Configuration for Tests - 只輸出錯誤級別日誌
logging:
  level:
    root: ERROR
    org.springframework: ERROR
    org.hibernate: ERROR
    solid.humank.genaidemo: ERROR
    org.springframework.web: ERROR
    org.springframework.boot.autoconfigure: ERROR
    org.h2: ERROR
    io.cucumber: ERROR
    org.junit: ERROR
    org.mockito: ERROR
    com.tngtech.archunit: ERROR
    io.qameta.allure: ERROR

# Management Endpoints - Minimal configuration for tests
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: always
      show-components: always
      probes:
        enabled: false  # Disable Kubernetes probes in tests
    prometheus:
      enabled: true
    metrics:
      enabled: true
  health:
    livenessstate:
      enabled: false  # Disable liveness state in tests
    readinessstate:
      enabled: false  # Disable readiness state in tests
    defaults:
      enabled: false  # Disable default health indicators that might cause issues
    db:
      enabled: true   # Keep database health check
    diskspace:
      enabled: false  # Disable disk space check for tests
  metrics:
    enable:
      all: true
  prometheus:
    metrics:
      export:
        enabled: true

# Profile Configuration Properties
app:
  profile:
    name: test
    description: Test environment with isolated configuration
    features:
      h2-console: false
      debug-logging: false
      in-memory-events: true
      kafka-events: false
    validation:
      strict: false  # Disable strict validation in tests

genai-demo:
  events:
    publisher: in-memory
    async: false

# Additional test configuration
info:
  app:
    version: 2.0.0

# OpenAPI Configuration
springdoc:
  api-docs:
    enabled: true
    path: /v3/api-docs
  swagger-ui:
    enabled: true
    path: /swagger-ui.html

# Tracing Configuration - Use noop for tests to avoid global state issues
tracing:
  enabled: true  # Enable but use noop implementation