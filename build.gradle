// æ ¹ç›®éŒ„ build.gradle - å¤šæ¨¡çµ„é …ç›®é…ç½®
// é€™å€‹é …ç›®åŒ…å«ï¼š
// - app: Spring Boot Java å¾Œç«¯æ‡‰ç”¨
// - cmc-frontend: Next.js ç®¡ç†å‰ç«¯ (CMC = Content Management Console)
// - consumer-frontend: Angular æ¶ˆè²»è€…å‰ç«¯
// - infrastructure: AWS CDK åŸºç¤è¨­æ–½å³ä»£ç¢¼

plugins {
    id 'org.springframework.boot' version '3.5.8' apply false
    id 'io.spring.dependency-management' version '1.1.7' apply false
}

// å…¨å±€é…ç½®
allprojects {
    group = 'solid.humank'
    version = '1.0.0'

    repositories {
        mavenCentral()
    }
}

// åªå° Java å­é …ç›®æ‡‰ç”¨é…ç½®
subprojects {
    // åªå° app æ¨¡çµ„æ‡‰ç”¨ Java ç›¸é—œé…ç½®
    if (name == 'app') {
        apply plugin: 'java'
        apply plugin: 'org.springframework.boot'
        apply plugin: 'io.spring.dependency-management'

        java {
            sourceCompatibility = JavaVersion.VERSION_21
            targetCompatibility = JavaVersion.VERSION_21
        }

        // Spring Boot æ‡‰ç”¨çš„ä¸»é¡é…ç½®
        springBoot {
            mainClass = 'solid.humank.genaidemo.GenAiDemoApplication'
        }

        // é€šç”¨çš„ bootRun é…ç½®
        bootRun {
            systemProperty 'spring.profiles.active', System.getProperty('spring.profiles.active', 'local')
        }
    }
}

// æ ¹ç´šåˆ¥çš„ä»»å‹™å®šç¾©
tasks.register('buildAll') {
    description = 'æ§‹å»ºæ‰€æœ‰æ¨¡çµ„'
    group = 'build'

    dependsOn ':app:build'

    doLast {
        println "âœ… æ‰€æœ‰æ¨¡çµ„æ§‹å»ºå®Œæˆ"
        println "  - Java å¾Œç«¯: app"
        println "  - å‰ç«¯æ¨¡çµ„éœ€è¦å–®ç¨ä½¿ç”¨ npm/yarn æ§‹å»º"
        println "    - CMC Frontend: cd cmc-frontend && npm run build"
        println "    - Consumer Frontend: cd consumer-frontend && npm run build"
        println "  - åŸºç¤è¨­æ–½: cd infrastructure && npm run build"
    }
}

tasks.register('testAll') {
    description = 'é‹è¡Œæ‰€æœ‰æ¨¡çµ„çš„æ¸¬è©¦'
    group = 'verification'

    dependsOn ':app:test'

    doLast {
        println "âœ… æ‰€æœ‰ Java æ¸¬è©¦å®Œæˆ"
        println "  å‰ç«¯æ¸¬è©¦éœ€è¦å–®ç¨é‹è¡Œï¼š"
        println "    - CMC Frontend: cd cmc-frontend && npm test"
        println "    - Consumer Frontend: cd consumer-frontend && npm test"
        println "    - Infrastructure: cd infrastructure && npm test"
    }
}

tasks.register('cleanAll') {
    description = 'æ¸…ç†æ‰€æœ‰æ¨¡çµ„'
    group = 'build'

    dependsOn ':app:clean'

    doLast {
        println "âœ… Java æ¨¡çµ„æ¸…ç†å®Œæˆ"
        println "  å‰ç«¯æ¸…ç†éœ€è¦å–®ç¨é‹è¡Œï¼š"
        println "    - rm -rf cmc-frontend/node_modules cmc-frontend/.next"
        println "    - rm -rf consumer-frontend/node_modules consumer-frontend/dist"
        println "    - rm -rf infrastructure/node_modules infrastructure/cdk.out"
    }
}

// é–‹ç™¼ç’°å¢ƒå¿«é€Ÿå•Ÿå‹•ä»»å‹™
tasks.register('devStart') {
    description = 'å•Ÿå‹•é–‹ç™¼ç’°å¢ƒ (åƒ…å¾Œç«¯)'
    group = 'application'

    dependsOn ':app:bootRun'

    doFirst {
        println "ğŸš€ å•Ÿå‹•é–‹ç™¼ç’°å¢ƒ..."
        println "  å¾Œç«¯å°‡åœ¨ http://localhost:8080 å•Ÿå‹•"
        println "  å‰ç«¯éœ€è¦å–®ç¨å•Ÿå‹•ï¼š"
        println "    - CMC Frontend: cd cmc-frontend && npm run dev (http://localhost:3000)"
        println "    - Consumer Frontend: cd consumer-frontend && npm start (http://localhost:4200)"
    }
}

// é …ç›®ä¿¡æ¯ä»»å‹™
tasks.register('projectInfo') {
    description = 'é¡¯ç¤ºé …ç›®çµæ§‹ä¿¡æ¯'
    group = 'help'

    doLast {
        println """
        ğŸ“‹ GenAI Demo é …ç›®çµæ§‹:

        ğŸ—ï¸  æ¶æ§‹æ¦‚è¦½:
        â”œâ”€â”€ app/                    # Spring Boot å¾Œç«¯æ‡‰ç”¨ (Java 21)
        â”‚   â”œâ”€â”€ src/main/java/      # ä¸»è¦æºç¢¼ (DDD + å…­é‚Šå½¢æ¶æ§‹)
        â”‚   â”œâ”€â”€ src/test/java/      # æ¸¬è©¦ä»£ç¢¼ (å–®å…ƒæ¸¬è©¦ + é›†æˆæ¸¬è©¦)
        â”‚   â””â”€â”€ build.gradle        # Java æ§‹å»ºé…ç½®
        â”‚
        â”œâ”€â”€ cmc-frontend/           # ç®¡ç†å‰ç«¯ (Next.js + TypeScript)
        â”‚   â”œâ”€â”€ src/                # React çµ„ä»¶å’Œé é¢
        â”‚   â”œâ”€â”€ package.json        # Node.js ä¾è³´
        â”‚   â””â”€â”€ next.config.js      # Next.js é…ç½®
        â”‚
        â”œâ”€â”€ consumer-frontend/      # æ¶ˆè²»è€…å‰ç«¯ (Angular + TypeScript)
        â”‚   â”œâ”€â”€ src/                # Angular çµ„ä»¶å’Œæœå‹™
        â”‚   â”œâ”€â”€ package.json        # Node.js ä¾è³´
        â”‚   â””â”€â”€ angular.json        # Angular é…ç½®
        â”‚
        â”œâ”€â”€ infrastructure/         # AWS CDK åŸºç¤è¨­æ–½ (TypeScript)
        â”‚   â”œâ”€â”€ lib/                # CDK å †ç–Šå®šç¾©
        â”‚   â”œâ”€â”€ package.json        # Node.js ä¾è³´
        â”‚   â””â”€â”€ cdk.json            # CDK é…ç½®
        â”‚
        â””â”€â”€ deployment/             # éƒ¨ç½²è…³æœ¬å’Œé…ç½®

        ğŸ› ï¸  é–‹ç™¼å‘½ä»¤:
        - ./gradlew :app:bootRun           # å•Ÿå‹•å¾Œç«¯
        - ./gradlew :app:test              # é‹è¡Œå¾Œç«¯æ¸¬è©¦
        - cd cmc-frontend && npm run dev   # å•Ÿå‹•ç®¡ç†å‰ç«¯
        - cd consumer-frontend && npm start # å•Ÿå‹•æ¶ˆè²»è€…å‰ç«¯
        - cd infrastructure && cdk deploy  # éƒ¨ç½²åŸºç¤è¨­æ–½

        ğŸ“š æ›´å¤šä¿¡æ¯è«‹æŸ¥çœ‹å„æ¨¡çµ„çš„ README.md æ–‡ä»¶
        """
    }
}

// é»˜èªä»»å‹™
defaultTasks 'projectInfo'
