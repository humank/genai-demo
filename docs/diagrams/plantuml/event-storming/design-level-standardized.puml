@startuml Design Level Event Storming - 標準化版本
!theme plain
title GenAI Demo - Design Level Event Storming (標準化配色)

' Event Storming Design Level 標準配色定義
skinparam rectangle {
    ' 事件 - 橙色系 (#FFA500)
    BackgroundColor<<Event>> #FFA500
    BorderColor<<Event>> #FF8C00
    FontColor<<Event>> #000000
    
    ' 命令 - 藍色系 (#1E90FF)
    BackgroundColor<<Command>> #1E90FF
    BorderColor<<Command>> #0000FF
    FontColor<<Command>> #FFFFFF
    
    ' 聚合 - 黃色系 (#FFFF00)
    BackgroundColor<<Aggregate>> #FFFF00
    BorderColor<<Aggregate>> #FFD700
    FontColor<<Aggregate>> #000000
    
    ' 讀模型 - 綠色系 (#32CD32)
    BackgroundColor<<ReadModel>> #32CD32
    BorderColor<<ReadModel>> #228B22
    FontColor<<ReadModel>> #000000
    
    ' 策略 - 紫色系 (#800080)
    BackgroundColor<<Policy>> #800080
    BorderColor<<Policy>> #4B0082
    FontColor<<Policy>> #FFFFFF
    
    ' 服務 - 淺藍色系 (#ADD8E6)
    BackgroundColor<<Service>> #ADD8E6
    BorderColor<<Service>> #87CEEB
    FontColor<<Service>> #000000
    
    ' 參與者 - 黃色系 (#FFD700)
    BackgroundColor<<Actor>> #FFD700
    BorderColor<<Actor>> #DAA520
    FontColor<<Actor>> #000000
    
    ' 外部系統 - 粉色系 (#FF69B4)
    BackgroundColor<<ExternalSystem>> #FF69B4
    BorderColor<<ExternalSystem>> #FF1493
    FontColor<<ExternalSystem>> #000000
}

' 界限上下文邊框樣式
skinparam package {
    BackgroundColor #F0F8FF
    BorderColor #4682B4
    BorderThickness 3
    FontStyle bold
    FontSize 14
}

' 參與者
rectangle "消費者" as Customer <<Actor>>
rectangle "管理員" as Admin <<Actor>>
rectangle "客服人員" as Support <<Actor>>

' 外部系統
rectangle "支付閘道" as PaymentGateway <<ExternalSystem>>
rectangle "物流系統" as LogisticsSystem <<ExternalSystem>>
rectangle "郵件服務" as EmailService <<ExternalSystem>>
rectangle "簡訊服務" as SMSService <<ExternalSystem>>
rectangle "庫存管理系統" as InventorySystem <<ExternalSystem>>

' 訂單上下文 (Order Bounded Context)
package "訂單上下文 (Order Context)" {
    ' 命令
    rectangle "創建訂單" as CreateOrder <<Command>>
    rectangle "添加訂單項目" as AddOrderItem <<Command>>
    rectangle "提交訂單" as SubmitOrder <<Command>>
    rectangle "確認訂單" as ConfirmOrder <<Command>>
    rectangle "取消訂單" as CancelOrder <<Command>>
    
    ' 聚合
    rectangle "訂單聚合" as OrderAggregate <<Aggregate>>
    
    ' 事件
    rectangle "訂單已創建" as OrderCreated <<Event>>
    rectangle "訂單項目已添加" as OrderItemAdded <<Event>>
    rectangle "訂單已提交" as OrderSubmitted <<Event>>
    rectangle "訂單已確認" as OrderConfirmed <<Event>>
    rectangle "訂單已取消" as OrderCancelled <<Event>>
    
    ' 讀模型
    rectangle "訂單摘要視圖" as OrderSummaryView <<ReadModel>>
    rectangle "訂單詳情視圖" as OrderDetailView <<ReadModel>>
    rectangle "訂單歷史視圖" as OrderHistoryView <<ReadModel>>
    
    ' 服務
    rectangle "訂單工作流服務" as OrderWorkflowService <<Service>>
    rectangle "訂單驗證服務" as OrderValidationService <<Service>>
}

' 支付上下文 (Payment Bounded Context)
package "支付上下文 (Payment Context)" {
    ' 命令
    rectangle "處理支付" as ProcessPayment <<Command>>
    rectangle "重試支付" as RetryPayment <<Command>>
    rectangle "申請退款" as RequestRefund <<Command>>
    
    ' 聚合
    rectangle "支付聚合" as PaymentAggregate <<Aggregate>>
    
    ' 事件
    rectangle "支付已請求" as PaymentRequested <<Event>>
    rectangle "支付已完成" as PaymentCompleted <<Event>>
    rectangle "支付已失敗" as PaymentFailed <<Event>>
    rectangle "退款已處理" as RefundProcessed <<Event>>
    
    ' 讀模型
    rectangle "支付狀態視圖" as PaymentStatusView <<ReadModel>>
    rectangle "支付歷史視圖" as PaymentHistoryView <<ReadModel>>
    
    ' 策略
    rectangle "支付重試策略" as PaymentRetryPolicy <<Policy>>
    rectangle "風險評估策略" as RiskAssessmentPolicy <<Policy>>
    
    ' 服務
    rectangle "支付處理服務" as PaymentProcessingService <<Service>>
    rectangle "風險管理服務" as RiskManagementService <<Service>>
}

' 庫存上下文 (Inventory Bounded Context)
package "庫存上下文 (Inventory Context)" {
    ' 命令
    rectangle "檢查庫存" as CheckInventory <<Command>>
    rectangle "預留庫存" as ReserveInventory <<Command>>
    rectangle "釋放庫存" as ReleaseInventory <<Command>>
    rectangle "更新庫存" as UpdateInventory <<Command>>
    
    ' 聚合
    rectangle "庫存聚合" as InventoryAggregate <<Aggregate>>
    
    ' 事件
    rectangle "庫存已檢查" as InventoryChecked <<Event>>
    rectangle "庫存已預留" as InventoryReserved <<Event>>
    rectangle "庫存已釋放" as InventoryReleased <<Event>>
    rectangle "庫存不足" as InventoryInsufficient <<Event>>
    
    ' 讀模型
    rectangle "庫存狀態視圖" as InventoryStatusView <<ReadModel>>
    rectangle "庫存報表視圖" as InventoryReportView <<ReadModel>>
    
    ' 策略
    rectangle "庫存預留策略" as InventoryReservationPolicy <<Policy>>
    rectangle "補貨策略" as RestockPolicy <<Policy>>
    
    ' 服務
    rectangle "庫存管理服務" as InventoryManagementService <<Service>>
}

' 配送上下文 (Delivery Bounded Context)
package "配送上下文 (Delivery Context)" {
    ' 命令
    rectangle "安排配送" as ArrangeDelivery <<Command>>
    rectangle "更新配送狀態" as UpdateDeliveryStatus <<Command>>
    rectangle "完成配送" as CompleteDelivery <<Command>>
    rectangle "重新安排配送" as RescheduleDelivery <<Command>>
    
    ' 聚合
    rectangle "配送聚合" as DeliveryAggregate <<Aggregate>>
    
    ' 事件
    rectangle "配送已安排" as DeliveryArranged <<Event>>
    rectangle "配送狀態已更新" as DeliveryStatusUpdated <<Event>>
    rectangle "配送已完成" as DeliveryCompleted <<Event>>
    rectangle "配送已失敗" as DeliveryFailed <<Event>>
    
    ' 讀模型
    rectangle "配送追蹤視圖" as DeliveryTrackingView <<ReadModel>>
    rectangle "配送統計視圖" as DeliveryStatsView <<ReadModel>>
    
    ' 策略
    rectangle "配送路線策略" as DeliveryRoutePolicy <<Policy>>
    rectangle "配送重試策略" as DeliveryRetryPolicy <<Policy>>
    
    ' 服務
    rectangle "配送管理服務" as DeliveryManagementService <<Service>>
    rectangle "路線優化服務" as RouteOptimizationService <<Service>>
}

' 通知上下文 (Notification Bounded Context)
package "通知上下文 (Notification Context)" {
    ' 命令
    rectangle "發送通知" as SendNotification <<Command>>
    rectangle "批量發送通知" as SendBulkNotification <<Command>>
    
    ' 聚合
    rectangle "通知聚合" as NotificationAggregate <<Aggregate>>
    
    ' 事件
    rectangle "通知已發送" as NotificationSent <<Event>>
    rectangle "通知發送失敗" as NotificationFailed <<Event>>
    
    ' 讀模型
    rectangle "通知歷史視圖" as NotificationHistoryView <<ReadModel>>
    
    ' 策略
    rectangle "通知偏好策略" as NotificationPreferencePolicy <<Policy>>
    rectangle "通知頻率策略" as NotificationFrequencyPolicy <<Policy>>
    
    ' 服務
    rectangle "通知服務" as NotificationService <<Service>>
    rectangle "模板管理服務" as TemplateManagementService <<Service>>
}

' 客戶服務上下文 (Customer Service Context)
package "客戶服務上下文 (Customer Service Context)" {
    ' 命令
    rectangle "創建客服工單" as CreateSupportTicket <<Command>>
    rectangle "更新工單狀態" as UpdateTicketStatus <<Command>>
    rectangle "關閉工單" as CloseTicket <<Command>>
    
    ' 聚合
    rectangle "客服工單聚合" as SupportTicketAggregate <<Aggregate>>
    
    ' 事件
    rectangle "客服工單已創建" as SupportTicketCreated <<Event>>
    rectangle "工單狀態已更新" as TicketStatusUpdated <<Event>>
    rectangle "工單已關閉" as TicketClosed <<Event>>
    
    ' 讀模型
    rectangle "工單列表視圖" as TicketListView <<ReadModel>>
    rectangle "工單詳情視圖" as TicketDetailView <<ReadModel>>
    
    ' 服務
    rectangle "客服管理服務" as CustomerServiceManagementService <<Service>>
}

' 跨界限上下文的整合視圖
package "整合視圖上下文 (Integration View Context)" {
    rectangle "客戶訂單儀表板" as CustomerOrderDashboard <<ReadModel>>
    rectangle "業務分析報表" as BusinessAnalyticsReport <<ReadModel>>
    rectangle "運營監控視圖" as OperationalMonitoringView <<ReadModel>>
}

' 參與者與命令的互動
Customer --> CreateOrder
Customer --> AddOrderItem
Customer --> SubmitOrder
Customer --> CreateSupportTicket
Admin --> ConfirmOrder
Admin --> UpdateInventory
Support --> UpdateTicketStatus

' 命令到聚合的流程
CreateOrder --> OrderAggregate
AddOrderItem --> OrderAggregate
SubmitOrder --> OrderAggregate
ConfirmOrder --> OrderAggregate
CancelOrder --> OrderAggregate

ProcessPayment --> PaymentAggregate
RetryPayment --> PaymentAggregate
RequestRefund --> PaymentAggregate

CheckInventory --> InventoryAggregate
ReserveInventory --> InventoryAggregate
ReleaseInventory --> InventoryAggregate
UpdateInventory --> InventoryAggregate

ArrangeDelivery --> DeliveryAggregate
UpdateDeliveryStatus --> DeliveryAggregate
CompleteDelivery --> DeliveryAggregate

SendNotification --> NotificationAggregate
CreateSupportTicket --> SupportTicketAggregate

' 聚合到事件的發布
OrderAggregate --> OrderCreated
OrderAggregate --> OrderItemAdded
OrderAggregate --> OrderSubmitted
OrderAggregate --> OrderConfirmed
OrderAggregate --> OrderCancelled

PaymentAggregate --> PaymentRequested
PaymentAggregate --> PaymentCompleted
PaymentAggregate --> PaymentFailed
PaymentAggregate --> RefundProcessed

InventoryAggregate --> InventoryChecked
InventoryAggregate --> InventoryReserved
InventoryAggregate --> InventoryReleased
InventoryAggregate --> InventoryInsufficient

DeliveryAggregate --> DeliveryArranged
DeliveryAggregate --> DeliveryStatusUpdated
DeliveryAggregate --> DeliveryCompleted
DeliveryAggregate --> DeliveryFailed

NotificationAggregate --> NotificationSent
NotificationAggregate --> NotificationFailed

SupportTicketAggregate --> SupportTicketCreated
SupportTicketAggregate --> TicketStatusUpdated
SupportTicketAggregate --> TicketClosed

' 跨界限上下文的事件整合 (紅色粗線表示)
OrderSubmitted -[#red,thickness=3]-> CheckInventory : 觸發庫存檢查
InventoryReserved -[#red,thickness=3]-> ProcessPayment : 觸發支付處理
PaymentCompleted -[#red,thickness=3]-> ConfirmOrder : 觸發訂單確認
OrderConfirmed -[#red,thickness=3]-> ArrangeDelivery : 觸發配送安排
OrderCancelled -[#red,thickness=3]-> ReleaseInventory : 觸發庫存釋放
PaymentCompleted -[#red,thickness=3]-> SendNotification : 觸發通知發送
DeliveryCompleted -[#red,thickness=3]-> SendNotification : 觸發送達通知

' 策略觸發
InventoryChecked --> InventoryReservationPolicy
PaymentFailed --> PaymentRetryPolicy
PaymentRequested --> RiskAssessmentPolicy
DeliveryArranged --> DeliveryRoutePolicy
NotificationSent --> NotificationFrequencyPolicy

' 事件到讀模型的投影 (綠色虛線)
OrderCreated -[#green,dashed]-> OrderSummaryView
OrderItemAdded -[#green,dashed]-> OrderDetailView
OrderConfirmed -[#green,dashed]-> OrderHistoryView
PaymentCompleted -[#green,dashed]-> PaymentStatusView
PaymentCompleted -[#green,dashed]-> PaymentHistoryView
InventoryReserved -[#green,dashed]-> InventoryStatusView
DeliveryArranged -[#green,dashed]-> DeliveryTrackingView
NotificationSent -[#green,dashed]-> NotificationHistoryView
SupportTicketCreated -[#green,dashed]-> TicketListView

' 跨界限上下文讀模型投影 (紫色虛線)
OrderCreated -[#purple,dashed,thickness=2]-> CustomerOrderDashboard
PaymentCompleted -[#purple,dashed,thickness=2]-> CustomerOrderDashboard
DeliveryCompleted -[#purple,dashed,thickness=2]-> CustomerOrderDashboard
OrderConfirmed -[#purple,dashed,thickness=2]-> BusinessAnalyticsReport
PaymentCompleted -[#purple,dashed,thickness=2]-> BusinessAnalyticsReport
DeliveryCompleted -[#purple,dashed,thickness=2]-> OperationalMonitoringView

' 外部系統整合 (粉色線)
PaymentProcessingService -[#pink]-> PaymentGateway
InventoryManagementService -[#pink]-> InventorySystem
DeliveryManagementService -[#pink]-> LogisticsSystem
NotificationService -[#pink]-> EmailService
NotificationService -[#pink]-> SMSService

' 圖例
legend right
  |= 元素類型 |= 顏色 |= 說明 |
  | <back:#FFD700>   </back> | 參與者 | 執行命令的人或角色 |
  | <back:#1E90FF>   </back> | 命令 | 觸發業務行為的意圖 |
  | <back:#FFFF00>   </back> | 聚合 | 維護業務規則和一致性的實體 |
  | <back:#FFA500>   </back> | 事件 | 業務狀態變化的結果 |
  | <back:#32CD32>   </back> | 讀模型 | 用戶查詢的資訊視圖 |
  | <back:#800080>   </back> | 策略 | 事件觸發的業務規則 |
  | <back:#ADD8E6>   </back> | 服務 | 協調聚合和處理複雜業務邏輯 |
  | <back:#FF69B4>   </back> | 外部系統 | 整合的外部服務 |
  |= 界限上下文 |= 說明 |
  | <back:#F0F8FF>   </back> | 藍色邊框 | 界限上下文邊界 |
  |= 連線類型 |= 顏色 |= 說明 |
  | 實線箭頭 | 黑色 | 命令執行或事件發布 |
  | 粗實線 | 紅色 | 跨界限上下文的事件整合 |
  | 虛線 | 綠色 | 事件到讀模型的投影 |
  | 粗虛線 | 紫色 | 跨界限上下文的讀模型投影 |
  | 實線 | 粉色 | 外部系統整合 |
endlegend

note top of Customer
  Design Level 階段重點：
  - 完整的界限上下文設計
  - 聚合邊界和職責劃分
  - 跨上下文的事件整合
  - 服務和外部系統整合
  - 讀模型投影策略
end note

@enduml