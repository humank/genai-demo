@startuml Event Storming Process Level
!theme plain
skinparam backgroundColor #FFFEF7
skinparam defaultFontName "Microsoft JhengHei"

title Event Storming Process Level\\nOrder Processing Workflow Detail

' Event Storming 標準配色
!define DOMAIN_EVENT_COLOR #FF8C00
!define COMMAND_COLOR #87CEEB
!define AGGREGATE_COLOR #FFFF99
!define POLICY_COLOR #DDA0DD
!define READ_MODEL_COLOR #90EE90
!define EXTERNAL_SYSTEM_COLOR #FFB6C1
!define USER_COLOR #F0E68C
!define HOTSPOT_COLOR #FF6347

' 用戶
actor "顧客" as Customer <<USER_COLOR>>
actor "系統" as System <<USER_COLOR>>

' 外部系統
cloud "Stripe" as StripePayment <<EXTERNAL_SYSTEM_COLOR>>
cloud "庫存系統" as InventorySystem <<EXTERNAL_SYSTEM_COLOR>>
cloud "通知服務" as NotificationService <<EXTERNAL_SYSTEM_COLOR>>

package "Order Creation Process - 訂單創建流程" {
    
    ' 第一階段：購物車到訂單
    rectangle "提交訂單" as SubmitOrderCmd <<COMMAND_COLOR>>
    rectangle "OrderCreatedEvent" as OrderCreatedEvt <<DOMAIN_EVENT_COLOR>>
    rectangle "Order" as OrderAgg <<AGGREGATE_COLOR>>
    rectangle "驗證訂單" as ValidateOrderPolicy <<POLICY_COLOR>>
    
    ' 第二階段：庫存檢查與預留
    rectangle "檢查庫存" as CheckInventoryCmd <<COMMAND_COLOR>>
    rectangle "InventoryCheckedEvent" as InventoryCheckedEvt <<DOMAIN_EVENT_COLOR>>
    rectangle "Inventory" as InventoryAgg <<AGGREGATE_COLOR>>
    rectangle "庫存預留策略" as InventoryReservationPolicy <<POLICY_COLOR>>
    
    rectangle "預留庫存" as ReserveInventoryCmd <<COMMAND_COLOR>>
    rectangle "InventoryReservedEvent" as InventoryReservedEvt <<DOMAIN_EVENT_COLOR>>
    rectangle "庫存不足處理" as InsufficientInventoryPolicy <<POLICY_COLOR>>
    
    ' 第三階段：價格計算
    rectangle "計算價格" as CalculatePriceCmd <<COMMAND_COLOR>>
    rectangle "PriceCalculatedEvent" as PriceCalculatedEvt <<DOMAIN_EVENT_COLOR>>
    rectangle "Pricing" as PricingAgg <<AGGREGATE_COLOR>>
    rectangle "動態定價策略" as DynamicPricingPolicy <<POLICY_COLOR>>
    
    ' 第四階段：優惠券應用
    rectangle "應用優惠券" as ApplyPromotionCmd <<COMMAND_COLOR>>
    rectangle "PromotionAppliedEvent" as PromotionAppliedEvt <<DOMAIN_EVENT_COLOR>>
    rectangle "Promotion" as PromotionAgg <<AGGREGATE_COLOR>>
    rectangle "優惠券驗證" as VoucherValidationPolicy <<POLICY_COLOR>>
    
    ' 第五階段：訂單提交
    rectangle "OrderSubmittedEvent" as OrderSubmittedEvt <<DOMAIN_EVENT_COLOR>>
    rectangle "訂單提交策略" as OrderSubmissionPolicy <<POLICY_COLOR>>
}

package "Payment Processing - 支付處理流程" {
    
    ' 支付請求
    rectangle "請求支付" as RequestPaymentCmd <<COMMAND_COLOR>>
    rectangle "PaymentRequestedEvent" as PaymentRequestedEvt <<DOMAIN_EVENT_COLOR>>
    rectangle "Payment" as PaymentAgg <<AGGREGATE_COLOR>>
    rectangle "支付方式選擇" as PaymentMethodPolicy <<POLICY_COLOR>>
    
    ' 支付處理
    rectangle "處理支付" as ProcessPaymentCmd <<COMMAND_COLOR>>
    rectangle "PaymentProcessedEvent" as PaymentProcessedEvt <<DOMAIN_EVENT_COLOR>>
    rectangle "支付驗證策略" as PaymentValidationPolicy <<POLICY_COLOR>>
    
    ' 支付結果處理
    rectangle "PaymentSucceededEvent" as PaymentSucceededEvt <<DOMAIN_EVENT_COLOR>>
    rectangle "PaymentFailedEvent" as PaymentFailedEvt <<DOMAIN_EVENT_COLOR>>
    rectangle "支付失敗補償" as PaymentFailureCompensationPolicy <<POLICY_COLOR>>
}

package "Order Confirmation - 訂單確認流程" {
    
    ' 訂單確認
    rectangle "確認訂單" as ConfirmOrderCmd <<COMMAND_COLOR>>
    rectangle "OrderConfirmedEvent" as OrderConfirmedEvt <<DOMAIN_EVENT_COLOR>>
    rectangle "訂單確認策略" as OrderConfirmationPolicy <<POLICY_COLOR>>
    
    ' 通知發送
    rectangle "發送通知" as SendNotificationCmd <<COMMAND_COLOR>>
    rectangle "NotificationSentEvent" as NotificationSentEvt <<DOMAIN_EVENT_COLOR>>
    rectangle "Notification" as NotificationAgg <<AGGREGATE_COLOR>>
    rectangle "通知渠道選擇" as NotificationChannelPolicy <<POLICY_COLOR>>
}

' 讀模型
rectangle "訂單詳情視圖" as OrderDetailView <<READ_MODEL_COLOR>>
rectangle "庫存狀態視圖" as InventoryStatusView <<READ_MODEL_COLOR>>
rectangle "支付記錄視圖" as PaymentRecordView <<READ_MODEL_COLOR>>
rectangle "客戶通知視圖" as CustomerNotificationView <<READ_MODEL_COLOR>>

' 熱點問題
note as HotSpot1 <<HOTSPOT_COLOR>>
  併發問題：
  - 多用戶同時下單同一商品
  - 庫存超賣問題
  - 支付重複扣款
end note

note as HotSpot2 <<HOTSPOT_COLOR>>
  一致性問題：
  - 訂單與庫存狀態同步
  - 支付與訂單狀態一致性
  - 分布式事務處理
end note

note as HotSpot3 <<HOTSPOT_COLOR>>
  性能瓶頸：
  - 價格計算複雜度
  - 優惠券規則引擎
  - 通知發送延遲
end note

' 流程連接 - 訂單創建階段
Customer --> SubmitOrderCmd : "提交購物車"
SubmitOrderCmd --> OrderCreatedEvt
OrderCreatedEvt --> OrderAgg
OrderCreatedEvt --> ValidateOrderPolicy

ValidateOrderPolicy --> CheckInventoryCmd
CheckInventoryCmd --> InventoryCheckedEvt
InventoryCheckedEvt --> InventoryAgg
InventoryCheckedEvt --> InventoryReservationPolicy

InventoryReservationPolicy --> ReserveInventoryCmd
ReserveInventoryCmd --> InventoryReservedEvt
InventoryReservedEvt --> InsufficientInventoryPolicy

InventoryReservedEvt --> CalculatePriceCmd
CalculatePriceCmd --> PriceCalculatedEvt
PriceCalculatedEvt --> PricingAgg
PriceCalculatedEvt --> DynamicPricingPolicy

DynamicPricingPolicy --> ApplyPromotionCmd
ApplyPromotionCmd --> PromotionAppliedEvt
PromotionAppliedEvt --> PromotionAgg
PromotionAppliedEvt --> VoucherValidationPolicy

VoucherValidationPolicy --> OrderSubmittedEvt
OrderSubmittedEvt --> OrderSubmissionPolicy

' 支付處理階段
OrderSubmittedEvt --> RequestPaymentCmd
RequestPaymentCmd --> PaymentRequestedEvt
PaymentRequestedEvt --> PaymentAgg
PaymentRequestedEvt --> PaymentMethodPolicy

PaymentMethodPolicy --> ProcessPaymentCmd
ProcessPaymentCmd --> PaymentProcessedEvt
PaymentProcessedEvt --> PaymentValidationPolicy
PaymentValidationPolicy --> StripePayment

PaymentProcessedEvt --> PaymentSucceededEvt
PaymentProcessedEvt --> PaymentFailedEvt
PaymentFailedEvt --> PaymentFailureCompensationPolicy

' 訂單確認階段
PaymentSucceededEvt --> ConfirmOrderCmd
ConfirmOrderCmd --> OrderConfirmedEvt
OrderConfirmedEvt --> OrderConfirmationPolicy

OrderConfirmedEvt --> SendNotificationCmd
SendNotificationCmd --> NotificationSentEvt
NotificationSentEvt --> NotificationAgg
NotificationSentEvt --> NotificationChannelPolicy
NotificationChannelPolicy --> NotificationService

' 讀模型更新
OrderCreatedEvt --> OrderDetailView
InventoryReservedEvt --> InventoryStatusView
PaymentProcessedEvt --> PaymentRecordView
NotificationSentEvt --> CustomerNotificationView

' 補償流程
InsufficientInventoryPolicy --> OrderCreatedEvt : "取消訂單"
PaymentFailureCompensationPolicy --> InventoryReservedEvt : "釋放庫存"

' 外部系統整合
InventoryReservationPolicy --> InventorySystem
PaymentValidationPolicy --> StripePayment
NotificationChannelPolicy --> NotificationService

@enduml