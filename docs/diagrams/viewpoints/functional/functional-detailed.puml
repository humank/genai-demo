@startuml functional-detailed
!theme plain
skinparam classAttributeIconSize 0
skinparam classFontStyle bold

title 功能視點詳細設計圖\n(Functional Viewpoint Detailed Design)

package "應用服務層 (Application Service Layer)" {
    class CustomerApplicationService {
        -customerRepository: CustomerRepository
        -domainEventService: DomainEventApplicationService
        +registerCustomer(command: RegisterCustomerCommand): Customer
        +verifyCustomerEmail(command: VerifyEmailCommand): void
        +updateCustomerProfile(command: UpdateProfileCommand): Customer
        +getCustomer(customerId: CustomerId): Customer
    }
    
    class OrderApplicationService {
        -orderRepository: OrderRepository
        -inventoryService: InventoryService
        -pricingService: PricingService
        +createOrder(command: CreateOrderCommand): Order
        +cancelOrder(command: CancelOrderCommand): void
        +updateOrderStatus(command: UpdateOrderStatusCommand): Order
    }
    
    class ProductApplicationService {
        -productRepository: ProductRepository
        -categoryService: CategoryService
        +createProduct(command: CreateProductCommand): Product
        +updateProduct(command: UpdateProductCommand): Product
        +getProductsByCategory(category: Category): List<Product>
    }
}

package "領域層 (Domain Layer)" {
    
    package "聚合根 (Aggregate Roots)" {
        class Customer <<AggregateRoot>> {
            -id: CustomerId
            -name: CustomerName
            -email: Email
            -membershipLevel: MembershipLevel
            -status: CustomerStatus
            -addresses: List<DeliveryAddress>
            -paymentMethods: List<PaymentMethod>
            --
            +register(name: CustomerName, email: Email): Customer
            +verifyEmail(): void
            +updateProfile(name: CustomerName, email: Email): void
            +addDeliveryAddress(address: Address, type: AddressType): void
            +promoteToMembership(level: MembershipLevel): void
            +isActive(): boolean
            +isPremiumMember(): boolean
        }
        
        class Order <<AggregateRoot>> {
            -id: OrderId
            -customerId: CustomerId
            -items: List<OrderItem>
            -status: OrderStatus
            -totalAmount: Money
            -deliveryAddress: Address
            -paymentMethod: PaymentMethod
            --
            +create(customerId: CustomerId, items: List<OrderItem>): Order
            +addItem(item: OrderItem): void
            +removeItem(itemId: OrderItemId): void
            +calculateTotal(): Money
            +confirm(): void
            +cancel(): void
            +ship(): void
        }
        
        class Product <<AggregateRoot>> {
            -id: ProductId
            -name: ProductName
            -description: ProductDescription
            -price: Money
            -category: Category
            -inventory: InventoryLevel
            -status: ProductStatus
            --
            +create(name: ProductName, price: Money, category: Category): Product
            +updatePrice(newPrice: Money): void
            +updateInventory(quantity: int): void
            +isAvailable(): boolean
            +isInStock(): boolean
        }
    }
    
    package "實體 (Entities)" {
        class DeliveryAddress <<Entity>> {
            -id: DeliveryAddressId
            -address: Address
            -type: AddressType
            -isDefault: boolean
            --
            +markAsDefault(): void
            +isValidForDelivery(): boolean
        }
        
        class OrderItem <<Entity>> {
            -id: OrderItemId
            -productId: ProductId
            -quantity: int
            -unitPrice: Money
            -subtotal: Money
            --
            +calculateSubtotal(): Money
            +updateQuantity(newQuantity: int): void
        }
        
        class PaymentMethod <<Entity>> {
            -id: PaymentMethodId
            -type: PaymentType
            -details: PaymentDetails
            -isDefault: boolean
            --
            +isValid(): boolean
            +markAsDefault(): void
        }
    }
    
    package "值對象 (Value Objects)" {
        class CustomerId <<ValueObject>> {
            -value: String
            --
            +generate(): CustomerId
            +of(value: String): CustomerId
            +getShortId(): String
        }
        
        class Email <<ValueObject>> {
            -value: String
            --
            +getDomain(): String
            +getLocalPart(): String
            +isFromDomain(domain: String): boolean
        }
        
        class Money <<ValueObject>> {
            -amount: BigDecimal
            -currency: Currency
            --
            +add(other: Money): Money
            +subtract(other: Money): Money
            +multiply(multiplier: BigDecimal): Money
            +isZero(): boolean
        }
        
        class Address <<ValueObject>> {
            -street: String
            -city: String
            -postalCode: String
            -country: String
            --
            +isValid(): boolean
            +isDeliverable(): boolean
            +getFullAddress(): String
        }
    }
    
    package "領域服務 (Domain Services)" {
        class PricingService <<DomainService>> {
            +calculateOrderTotal(order: Order, promotions: List<Promotion>): Money
            +calculateDiscount(subtotal: Money, promotions: List<Promotion>): Money
            +calculateTax(amount: Money): Money
        }
        
        class InventoryAllocationService <<DomainService>> {
            +allocateInventory(order: Order): AllocationResult
            +releaseAllocation(order: Order): void
            +checkAvailability(items: List<OrderItem>): AvailabilityResult
        }
        
        class PromotionService <<DomainService>> {
            +getApplicablePromotions(order: Order): List<Promotion>
            +calculatePromotionDiscount(order: Order, promotion: Promotion): Money
            +validatePromotionRules(order: Order, promotion: Promotion): boolean
        }
    }
}

package "領域事件 (Domain Events)" {
    class CustomerRegisteredEvent <<DomainEvent>> {
        -customerId: CustomerId
        -customerName: CustomerName
        -email: Email
        -membershipLevel: MembershipLevel
        -eventId: UUID
        -occurredOn: LocalDateTime
        --
        +create(customerId: CustomerId, name: CustomerName, email: Email): CustomerRegisteredEvent
    }
    
    class OrderCreatedEvent <<DomainEvent>> {
        -orderId: OrderId
        -customerId: CustomerId
        -orderItems: List<OrderItem>
        -totalAmount: Money
        -eventId: UUID
        -occurredOn: LocalDateTime
        --
        +create(orderId: OrderId, customerId: CustomerId, items: List<OrderItem>): OrderCreatedEvent
    }
    
    class PaymentProcessedEvent <<DomainEvent>> {
        -paymentId: PaymentId
        -orderId: OrderId
        -amount: Money
        -paymentMethod: PaymentMethod
        -eventId: UUID
        -occurredOn: LocalDateTime
        --
        +create(paymentId: PaymentId, orderId: OrderId, amount: Money): PaymentProcessedEvent
    }
}

package "命令 (Commands)" {
    class RegisterCustomerCommand <<Command>> {
        -name: CustomerName
        -email: Email
        -initiatedBy: String
        -commandId: UUID
        -timestamp: LocalDateTime
    }
    
    class CreateOrderCommand <<Command>> {
        -customerId: CustomerId
        -items: List<OrderItemRequest>
        -deliveryAddress: Address
        -paymentMethod: PaymentMethod
        -initiatedBy: String
        -commandId: UUID
        -timestamp: LocalDateTime
    }
    
    class UpdateProfileCommand <<Command>> {
        -customerId: CustomerId
        -name: CustomerName
        -email: Email
        -initiatedBy: String
        -commandId: UUID
        -timestamp: LocalDateTime
    }
}

' 關係定義
CustomerApplicationService --> Customer : 協調
CustomerApplicationService --> RegisterCustomerCommand : 處理
CustomerApplicationService --> UpdateProfileCommand : 處理

OrderApplicationService --> Order : 協調
OrderApplicationService --> CreateOrderCommand : 處理
OrderApplicationService --> PricingService : 使用
OrderApplicationService --> InventoryAllocationService : 使用

ProductApplicationService --> Product : 協調

Customer --> CustomerId : 包含
Customer --> Email : 包含
Customer --> DeliveryAddress : 聚合
Customer --> PaymentMethod : 聚合
Customer --> CustomerRegisteredEvent : 產生

Order --> OrderItem : 聚合
Order --> Money : 使用
Order --> Address : 使用
Order --> OrderCreatedEvent : 產生

Product --> Money : 使用

OrderItem --> Money : 使用

DeliveryAddress --> Address : 使用

PricingService --> Money : 返回
InventoryAllocationService --> Order : 分析
PromotionService --> Money : 計算

' 樣式定義
skinparam class {
    BackgroundColor<<AggregateRoot>> LightBlue
    BorderColor<<AggregateRoot>> Blue
    
    BackgroundColor<<Entity>> LightGreen
    BorderColor<<Entity>> Green
    
    BackgroundColor<<ValueObject>> LightYellow
    BorderColor<<ValueObject>> Orange
    
    BackgroundColor<<DomainService>> LightPink
    BorderColor<<DomainService>> Red
    
    BackgroundColor<<DomainEvent>> Lavender
    BorderColor<<DomainEvent>> Purple
    
    BackgroundColor<<Command>> LightGray
    BorderColor<<Command>> Gray
}

@enduml