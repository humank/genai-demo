graph TB
    subgraph "事件生產者" ["事件生產者 (Event Producers)"]
        subgraph "聚合根" ["Aggregate Roots"]
            ORDER_AGG[Order<br/>訂單聚合根]
            CUSTOMER_AGG[Customer<br/>客戶聚合根]
            PRODUCT_AGG[Product<br/>產品聚合根]
            PAYMENT_AGG[Payment<br/>支付聚合根]
            INVENTORY_AGG[Inventory<br/>庫存聚合根]
            NOTIFICATION_AGG[Notification<br/>通知聚合根]
            OBSERVABILITY_AGG[ObservabilityMetric<br/>可觀測性聚合根]
        end
    end
    
    subgraph "領域事件" ["領域事件 (Domain Events)"]
        subgraph "訂單事件" ["Order Events"]
            ORDER_CREATED[OrderCreatedEvent<br/>訂單已創建]
            ORDER_UPDATED[OrderUpdatedEvent<br/>訂單已更新]
            ORDER_CANCELLED[OrderCancelledEvent<br/>訂單已取消]
            ORDER_SHIPPED[OrderShippedEvent<br/>訂單已發貨]
            ORDER_DELIVERED[OrderDeliveredEvent<br/>訂單已送達]
        end
        
        subgraph "客戶事件" ["Customer Events"]
            CUSTOMER_REGISTERED[CustomerRegisteredEvent<br/>客戶已註冊]
            CUSTOMER_UPDATED[CustomerUpdatedEvent<br/>客戶已更新]
            CUSTOMER_DEACTIVATED[CustomerDeactivatedEvent<br/>客戶已停用]
        end
        
        subgraph "產品事件" ["Product Events"]
            PRODUCT_CREATED[ProductCreatedEvent<br/>產品已創建]
            PRODUCT_UPDATED[ProductUpdatedEvent<br/>產品已更新]
            PRODUCT_DISCONTINUED[ProductDiscontinuedEvent<br/>產品已停產]
        end
        
        subgraph "支付事件" ["Payment Events"]
            PAYMENT_INITIATED[PaymentInitiatedEvent<br/>支付已發起]
            PAYMENT_PROCESSED[PaymentProcessedEvent<br/>支付已處理]
            PAYMENT_FAILED[PaymentFailedEvent<br/>支付已失敗]
            PAYMENT_REFUNDED[PaymentRefundedEvent<br/>支付已退款]
        end
        
        subgraph "庫存事件" ["Inventory Events"]
            INVENTORY_ALLOCATED[InventoryAllocatedEvent<br/>庫存已分配]
            INVENTORY_RELEASED[InventoryReleasedEvent<br/>庫存已釋放]
            INVENTORY_UPDATED[InventoryUpdatedEvent<br/>庫存已更新]
            INVENTORY_LOW[InventoryLowEvent<br/>庫存不足]
        end
        
        subgraph "通知事件" ["Notification Events"]
            NOTIFICATION_SENT[NotificationSentEvent<br/>通知已發送]
            NOTIFICATION_FAILED[NotificationFailedEvent<br/>通知發送失敗]
            EMAIL_SENT[EmailSentEvent<br/>郵件已發送]
            SMS_SENT[SmsSentEvent<br/>簡訊已發送]
        end
        
        subgraph "可觀測性事件" ["Observability Events"]
            METRIC_RECORDED[MetricRecordedEvent<br/>指標已記錄]
            ALERT_TRIGGERED[AlertTriggeredEvent<br/>告警已觸發]
            TRACE_COMPLETED[TraceCompletedEvent<br/>追蹤已完成]
        end
    end
    
    subgraph "事件基礎設施" ["事件基礎設施 (Event Infrastructure)"]
        subgraph "事件發布" ["Event Publishing"]
            EVENT_COLLECTOR[DomainEventCollector<br/>領域事件收集器]
            EVENT_PUBLISHER[DomainEventPublisher<br/>領域事件發布器]
            EVENT_SERIALIZER[EventSerializer<br/>事件序列化器]
        end
        
        subgraph "事件傳輸" ["Event Transport"]
            MSK_BROKER[MSK Kafka Broker<br/>事件訊息代理]
            EVENT_BRIDGE[AWS EventBridge<br/>事件橋接器]
            SQS_QUEUE[SQS 佇列<br/>事件佇列]
            SNS_TOPIC[SNS 主題<br/>事件主題]
        end
        
        subgraph "事件存儲" ["Event Storage"]
            EVENT_STORE[EventStore DB<br/>事件存儲資料庫]
            EVENT_JOURNAL[Event Journal<br/>事件日誌]
            SNAPSHOT_STORE[Snapshot Store<br/>快照存儲]
        end
        
        subgraph "事件路由" ["Event Routing"]
            EVENT_ROUTER[EventRouter<br/>事件路由器]
            TOPIC_MANAGER[TopicManager<br/>主題管理器]
            PARTITION_STRATEGY[PartitionStrategy<br/>分區策略]
        end
    end
    
    subgraph "事件處理器" ["事件處理器 (Event Handlers)"]
        subgraph "業務流程處理器" ["Business Process Handlers"]
            ORDER_SAGA[OrderProcessingSaga<br/>訂單處理 Saga]
            PAYMENT_SAGA[PaymentProcessingSaga<br/>支付處理 Saga]
            FULFILLMENT_SAGA[FulfillmentSaga<br/>履約 Saga]
            CUSTOMER_ONBOARDING_SAGA[CustomerOnboardingSaga<br/>客戶入職 Saga]
        end
        
        subgraph "跨聚合事件處理器" ["Cross-Aggregate Handlers"]
            INVENTORY_HANDLER[InventoryEventHandler<br/>庫存事件處理器]
            NOTIFICATION_HANDLER[NotificationEventHandler<br/>通知事件處理器]
            ANALYTICS_HANDLER[AnalyticsEventHandler<br/>分析事件處理器]
            AUDIT_HANDLER[AuditEventHandler<br/>審計事件處理器]
        end
        
        subgraph "整合事件處理器" ["Integration Handlers"]
            PAYMENT_INTEGRATION_HANDLER[PaymentIntegrationHandler<br/>支付整合處理器]
            LOGISTICS_INTEGRATION_HANDLER[LogisticsIntegrationHandler<br/>物流整合處理器]
            EMAIL_INTEGRATION_HANDLER[EmailIntegrationHandler<br/>郵件整合處理器]
            SEARCH_INDEX_HANDLER[SearchIndexHandler<br/>搜尋索引處理器]
        end
        
        subgraph "可觀測性處理器" ["Observability Handlers"]
            METRICS_HANDLER[MetricsEventHandler<br/>指標事件處理器]
            LOGGING_HANDLER[LoggingEventHandler<br/>日誌事件處理器]
            TRACING_HANDLER[TracingEventHandler<br/>追蹤事件處理器]
            ALERTING_HANDLER[AlertingEventHandler<br/>告警事件處理器]
        end
    end
    
    subgraph "外部系統整合" ["外部系統整合 (External Integrations)"]
        STRIPE_API[Stripe API<br/>支付閘道]
        LOGISTICS_API[Logistics API<br/>物流系統]
        EMAIL_SERVICE[Email Service<br/>郵件服務]
        SMS_SERVICE[SMS Service<br/>簡訊服務]
        SEARCH_ENGINE[Search Engine<br/>搜尋引擎]
        ANALYTICS_PLATFORM[Analytics Platform<br/>分析平台]
        MONITORING_SYSTEM[Monitoring System<br/>監控系統]
    end
    
    subgraph "事件消費者" ["事件消費者 (Event Consumers)"]
        READ_MODEL_UPDATER[ReadModelUpdater<br/>讀模型更新器]
        PROJECTION_BUILDER[ProjectionBuilder<br/>投影構建器]
        REPORT_GENERATOR[ReportGenerator<br/>報告生成器]
        DASHBOARD_UPDATER[DashboardUpdater<br/>儀表板更新器]
    end
    
    %% 聚合根產生事件
    ORDER_AGG -->|產生| ORDER_CREATED
    ORDER_AGG -->|產生| ORDER_UPDATED
    ORDER_AGG -->|產生| ORDER_CANCELLED
    ORDER_AGG -->|產生| ORDER_SHIPPED
    ORDER_AGG -->|產生| ORDER_DELIVERED
    
    CUSTOMER_AGG -->|產生| CUSTOMER_REGISTERED
    CUSTOMER_AGG -->|產生| CUSTOMER_UPDATED
    CUSTOMER_AGG -->|產生| CUSTOMER_DEACTIVATED
    
    PRODUCT_AGG -->|產生| PRODUCT_CREATED
    PRODUCT_AGG -->|產生| PRODUCT_UPDATED
    PRODUCT_AGG -->|產生| PRODUCT_DISCONTINUED
    
    PAYMENT_AGG -->|產生| PAYMENT_INITIATED
    PAYMENT_AGG -->|產生| PAYMENT_PROCESSED
    PAYMENT_AGG -->|產生| PAYMENT_FAILED
    PAYMENT_AGG -->|產生| PAYMENT_REFUNDED
    
    INVENTORY_AGG -->|產生| INVENTORY_ALLOCATED
    INVENTORY_AGG -->|產生| INVENTORY_RELEASED
    INVENTORY_AGG -->|產生| INVENTORY_UPDATED
    INVENTORY_AGG -->|產生| INVENTORY_LOW
    
    NOTIFICATION_AGG -->|產生| NOTIFICATION_SENT
    NOTIFICATION_AGG -->|產生| NOTIFICATION_FAILED
    NOTIFICATION_AGG -->|產生| EMAIL_SENT
    NOTIFICATION_AGG -->|產生| SMS_SENT
    
    OBSERVABILITY_AGG -->|產生| METRIC_RECORDED
    OBSERVABILITY_AGG -->|產生| ALERT_TRIGGERED
    OBSERVABILITY_AGG -->|產生| TRACE_COMPLETED
    
    %% 事件收集和發布
    ORDER_CREATED -->|收集| EVENT_COLLECTOR
    CUSTOMER_REGISTERED -->|收集| EVENT_COLLECTOR
    PAYMENT_PROCESSED -->|收集| EVENT_COLLECTOR
    INVENTORY_UPDATED -->|收集| EVENT_COLLECTOR
    
    EVENT_COLLECTOR -->|發布| EVENT_PUBLISHER
    EVENT_PUBLISHER -->|序列化| EVENT_SERIALIZER
    EVENT_SERIALIZER -->|傳輸| MSK_BROKER
    EVENT_SERIALIZER -->|傳輸| EVENT_BRIDGE
    EVENT_SERIALIZER -->|佇列| SQS_QUEUE
    EVENT_SERIALIZER -->|主題| SNS_TOPIC
    
    %% 事件存儲
    EVENT_PUBLISHER -->|存儲| EVENT_STORE
    EVENT_STORE -->|日誌| EVENT_JOURNAL
    EVENT_STORE -->|快照| SNAPSHOT_STORE
    
    %% 事件路由
    MSK_BROKER -->|路由| EVENT_ROUTER
    EVENT_ROUTER -->|管理| TOPIC_MANAGER
    EVENT_ROUTER -->|分區| PARTITION_STRATEGY
    
    %% Saga 處理
    ORDER_CREATED -->|觸發| ORDER_SAGA
    PAYMENT_INITIATED -->|觸發| PAYMENT_SAGA
    ORDER_SHIPPED -->|觸發| FULFILLMENT_SAGA
    CUSTOMER_REGISTERED -->|觸發| CUSTOMER_ONBOARDING_SAGA
    
    %% 跨聚合處理
    INVENTORY_LOW -->|處理| INVENTORY_HANDLER
    ORDER_CREATED -->|處理| NOTIFICATION_HANDLER
    PAYMENT_PROCESSED -->|處理| ANALYTICS_HANDLER
    ORDER_UPDATED -->|處理| AUDIT_HANDLER
    
    %% 整合處理
    PAYMENT_INITIATED -->|處理| PAYMENT_INTEGRATION_HANDLER
    ORDER_SHIPPED -->|處理| LOGISTICS_INTEGRATION_HANDLER
    CUSTOMER_REGISTERED -->|處理| EMAIL_INTEGRATION_HANDLER
    PRODUCT_UPDATED -->|處理| SEARCH_INDEX_HANDLER
    
    %% 可觀測性處理
    METRIC_RECORDED -->|處理| METRICS_HANDLER
    ORDER_CREATED -->|處理| LOGGING_HANDLER
    PAYMENT_PROCESSED -->|處理| TRACING_HANDLER
    ALERT_TRIGGERED -->|處理| ALERTING_HANDLER
    
    %% 外部系統整合
    PAYMENT_INTEGRATION_HANDLER -->|調用| STRIPE_API
    LOGISTICS_INTEGRATION_HANDLER -->|調用| LOGISTICS_API
    EMAIL_INTEGRATION_HANDLER -->|調用| EMAIL_SERVICE
    NOTIFICATION_HANDLER -->|調用| SMS_SERVICE
    SEARCH_INDEX_HANDLER -->|更新| SEARCH_ENGINE
    ANALYTICS_HANDLER -->|發送| ANALYTICS_PLATFORM
    METRICS_HANDLER -->|發送| MONITORING_SYSTEM
    
    %% 事件消費
    ORDER_CREATED -->|更新| READ_MODEL_UPDATER
    CUSTOMER_REGISTERED -->|構建| PROJECTION_BUILDER
    PAYMENT_PROCESSED -->|生成| REPORT_GENERATOR
    INVENTORY_UPDATED -->|更新| DASHBOARD_UPDATER
    
    %% Saga 協調
    ORDER_SAGA -->|協調| PAYMENT_INITIATED
    ORDER_SAGA -->|協調| INVENTORY_ALLOCATED
    PAYMENT_SAGA -->|協調| PAYMENT_PROCESSED
    FULFILLMENT_SAGA -->|協調| ORDER_DELIVERED
    
    classDef producer fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    classDef event fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef infrastructure fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    classDef handler fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef external fill:#ffebee,stroke:#c62828,stroke-width:2px
    classDef consumer fill:#e0f2f1,stroke:#00695c,stroke-width:2px
    
    class ORDER_AGG,CUSTOMER_AGG,PRODUCT_AGG,PAYMENT_AGG,INVENTORY_AGG,NOTIFICATION_AGG,OBSERVABILITY_AGG producer
    class ORDER_CREATED,ORDER_UPDATED,ORDER_CANCELLED,ORDER_SHIPPED,ORDER_DELIVERED,CUSTOMER_REGISTERED,CUSTOMER_UPDATED,CUSTOMER_DEACTIVATED,PRODUCT_CREATED,PRODUCT_UPDATED,PRODUCT_DISCONTINUED,PAYMENT_INITIATED,PAYMENT_PROCESSED,PAYMENT_FAILED,PAYMENT_REFUNDED,INVENTORY_ALLOCATED,INVENTORY_RELEASED,INVENTORY_UPDATED,INVENTORY_LOW,NOTIFICATION_SENT,NOTIFICATION_FAILED,EMAIL_SENT,SMS_SENT,METRIC_RECORDED,ALERT_TRIGGERED,TRACE_COMPLETED event
    class EVENT_COLLECTOR,EVENT_PUBLISHER,EVENT_SERIALIZER,MSK_BROKER,EVENT_BRIDGE,SQS_QUEUE,SNS_TOPIC,EVENT_STORE,EVENT_JOURNAL,SNAPSHOT_STORE,EVENT_ROUTER,TOPIC_MANAGER,PARTITION_STRATEGY infrastructure
    class ORDER_SAGA,PAYMENT_SAGA,FULFILLMENT_SAGA,CUSTOMER_ONBOARDING_SAGA,INVENTORY_HANDLER,NOTIFICATION_HANDLER,ANALYTICS_HANDLER,AUDIT_HANDLER,PAYMENT_INTEGRATION_HANDLER,LOGISTICS_INTEGRATION_HANDLER,EMAIL_INTEGRATION_HANDLER,SEARCH_INDEX_HANDLER,METRICS_HANDLER,LOGGING_HANDLER,TRACING_HANDLER,ALERTING_HANDLER handler
    class STRIPE_API,LOGISTICS_API,EMAIL_SERVICE,SMS_SERVICE,SEARCH_ENGINE,ANALYTICS_PLATFORM,MONITORING_SYSTEM external
    class READ_MODEL_UPDATER,PROJECTION_BUILDER,REPORT_GENERATOR,DASHBOARD_UPDATER consumer