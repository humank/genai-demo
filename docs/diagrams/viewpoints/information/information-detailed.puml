@startuml information-detailed
!theme plain
skinparam classAttributeIconSize 0
skinparam classFontStyle bold

title 資訊視點詳細設計圖\n(Information Viewpoint Detailed Design)

package "領域事件系統 (Domain Event System)" {
    
    interface DomainEvent {
        +getEventId(): UUID
        +getOccurredOn(): LocalDateTime
        +getEventType(): String
        +getAggregateId(): String
    }
    
    class CustomerRegisteredEvent {
        -customerId: CustomerId
        -customerName: CustomerName
        -email: Email
        -membershipLevel: MembershipLevel
        -eventId: UUID
        -occurredOn: LocalDateTime
        --
        +create(customerId, name, email): CustomerRegisteredEvent
    }
    
    class OrderCreatedEvent {
        -orderId: OrderId
        -customerId: CustomerId
        -orderItems: List<OrderItemData>
        -totalAmount: Money
        -eventId: UUID
        -occurredOn: LocalDateTime
        --
        +create(orderId, customerId, items, amount): OrderCreatedEvent
    }
    
    class PaymentProcessedEvent {
        -paymentId: PaymentId
        -orderId: OrderId
        -amount: Money
        -paymentMethod: PaymentMethod
        -status: PaymentStatus
        -eventId: UUID
        -occurredOn: LocalDateTime
        --
        +create(paymentId, orderId, amount, method): PaymentProcessedEvent
    }
    
    class DomainEventPublisher {
        -eventBus: EventBus
        -eventStore: EventStore
        --
        +publish(event: DomainEvent): void
        +publishAll(events: List<DomainEvent>): void
    }
    
    interface EventStore {
        +store(event: DomainEvent): void
        +getEventsForAggregate(aggregateId: String): List<DomainEvent>
        +getEventsByType(eventType: String): List<DomainEvent>
        +getAllEvents(): List<DomainEvent>
    }
    
    class JpaEventStore {
        -repository: StoredEventRepository
        -mapper: EventMapper
        --
        +store(event: DomainEvent): void
        +getEventsForAggregate(aggregateId: String): List<DomainEvent>
    }
    
    class EventStoreDbAdapter {
        -client: EventStoreDBClient
        --
        +store(event: DomainEvent): void
        +getEventsForAggregate(aggregateId: String): List<DomainEvent>
    }
}

package "資料模型 (Data Models)" {
    
    class CustomerEntity {
        -id: String
        -name: String
        -email: String
        -membershipLevel: MembershipLevel
        -status: CustomerStatus
        -createdAt: LocalDateTime
        -updatedAt: LocalDateTime
        --
        +getId(): String
        +getName(): String
        +getEmail(): String
    }
    
    class OrderEntity {
        -id: String
        -customerId: String
        -status: OrderStatus
        -totalAmount: BigDecimal
        -currency: String
        -items: List<OrderItemEntity>
        -createdAt: LocalDateTime
        -updatedAt: LocalDateTime
        --
        +calculateTotal(): BigDecimal
        +addItem(item: OrderItemEntity): void
    }
    
    class OrderItemEntity {
        -id: String
        -orderId: String
        -productId: String
        -quantity: Integer
        -unitPrice: BigDecimal
        -subtotal: BigDecimal
        --
        +calculateSubtotal(): BigDecimal
    }
    
    class ProductEntity {
        -id: String
        -name: String
        -description: String
        -price: BigDecimal
        -currency: String
        -categoryId: String
        -inventoryLevel: Integer
        -status: ProductStatus
        --
        +isAvailable(): boolean
        +updateInventory(quantity: Integer): void
    }
}

package "查詢模型 (Query Models)" {
    
    class CustomerSummaryView {
        -customerId: String
        -customerName: String
        -email: String
        -membershipLevel: String
        -status: String
        -totalOrders: Integer
        -totalSpent: BigDecimal
        -lastOrderDate: LocalDateTime
        -registrationDate: LocalDateTime
        -searchText: String
        -customerSegment: String
        --
        +getCustomerId(): String
        +getTotalOrders(): Integer
    }
    
    class OrderSummaryView {
        -orderId: String
        -customerId: String
        -customerName: String
        -status: String
        -totalAmount: BigDecimal
        -currency: String
        -itemCount: Integer
        -orderDate: LocalDateTime
        -estimatedDeliveryDate: LocalDateTime
        -productCategories: String
        -deliveryAddress: String
        --
        +getOrderId(): String
        +getItemCount(): Integer
    }
    
    class ProductCatalogView {
        -productId: String
        -productName: String
        -description: String
        -price: BigDecimal
        -currency: String
        -categoryName: String
        -inventoryLevel: Integer
        -averageRating: BigDecimal
        -reviewCount: Integer
        -imageUrls: String
        -tags: String
        --
        +isInStock(): boolean
        +getAverageRating(): BigDecimal
    }
}

package "資料存取層 (Data Access Layer)" {
    
    interface CustomerRepository {
        +findById(id: CustomerId): Optional<Customer>
        +save(customer: Customer): Customer
        +existsByEmail(email: Email): boolean
        +findByCriteria(criteria: CustomerSearchCriteria, pageable: Pageable): Page<Customer>
    }
    
    class JpaCustomerRepository {
        -jpaRepository: CustomerJpaRepository
        -mapper: CustomerMapper
        --
        +findById(id: CustomerId): Optional<Customer>
        +save(customer: Customer): Customer
        +existsByEmail(email: Email): boolean
    }
    
    interface OrderRepository {
        +findById(id: OrderId): Optional<Order>
        +save(order: Order): Order
        +findByCustomerId(customerId: CustomerId): List<Order>
        +findByStatus(status: OrderStatus): List<Order>
    }
    
    class JpaOrderRepository {
        -jpaRepository: OrderJpaRepository
        -mapper: OrderMapper
        --
        +findById(id: OrderId): Optional<Order>
        +save(order: Order): Order
        +findByCustomerId(customerId: CustomerId): List<Order>
    }
    
    class EventSourcedOrderRepository {
        -eventStore: EventStore
        -snapshotRepository: OrderSnapshotRepository
        --
        +findById(id: OrderId): Optional<Order>
        +save(order: Order): Order
        -replayEvents(events: List<DomainEvent>): Order
    }
}

package "查詢服務 (Query Services)" {
    
    class CustomerQueryService {
        -customerSummaryRepository: CustomerSummaryViewRepository
        -orderSummaryRepository: OrderSummaryViewRepository
        --
        +searchCustomers(criteria: CustomerSearchCriteria, pageable: Pageable): Page<CustomerSummaryView>
        +getCustomerDetail(customerId: String): CustomerDetailView
        +getCustomerOrderHistory(customerId: String, pageable: Pageable): Page<OrderSummaryView>
    }
    
    class OrderQueryService {
        -orderSummaryRepository: OrderSummaryViewRepository
        -orderDetailRepository: OrderDetailViewRepository
        --
        +getOrdersByCustomer(customerId: String, pageable: Pageable): Page<OrderSummaryView>
        +getOrderDetail(orderId: String): OrderDetailView
        +searchOrders(criteria: OrderSearchCriteria, pageable: Pageable): Page<OrderSummaryView>
    }
    
    class ProductQueryService {
        -productCatalogRepository: ProductCatalogViewRepository
        -searchService: ProductSearchService
        --
        +searchProducts(criteria: ProductSearchCriteria, pageable: Pageable): Page<ProductCatalogView>
        +getProductDetail(productId: String): ProductDetailView
        +getProductsByCategory(categoryId: String, pageable: Pageable): Page<ProductCatalogView>
        +getRecommendedProducts(customerId: String): List<ProductCatalogView>
    }
}

package "事件處理器 (Event Handlers)" {
    
    abstract class AbstractDomainEventHandler<T> {
        #logger: Logger
        #processedEventRepository: ProcessedEventRepository
        --
        +handle(event: T): void
        #isEventAlreadyProcessed(eventId: UUID): boolean
        #markEventAsProcessed(eventId: UUID): void
        +abstract getSupportedEventType(): Class<T>
    }
    
    class CustomerRegisteredEventHandler {
        -customerSummaryRepository: CustomerSummaryViewRepository
        -emailService: EmailService
        -statisticsService: CustomerStatisticsService
        --
        +handle(event: CustomerRegisteredEvent): void
        +getSupportedEventType(): Class<CustomerRegisteredEvent>
        -createCustomerSummary(event: CustomerRegisteredEvent): void
        -sendWelcomeEmail(event: CustomerRegisteredEvent): void
    }
    
    class OrderCreatedEventHandler {
        -orderSummaryRepository: OrderSummaryViewRepository
        -customerRepository: CustomerRepository
        -inventoryService: InventoryService
        --
        +handle(event: OrderCreatedEvent): void
        +getSupportedEventType(): Class<OrderCreatedEvent>
        -createOrderSummary(event: OrderCreatedEvent): void
        -updateCustomerStatistics(event: OrderCreatedEvent): void
        -reserveInventory(event: OrderCreatedEvent): void
    }
    
    class PaymentProcessedEventHandler {
        -orderRepository: OrderRepository
        -notificationService: NotificationService
        -auditService: AuditService
        --
        +handle(event: PaymentProcessedEvent): void
        +getSupportedEventType(): Class<PaymentProcessedEvent>
        -updateOrderStatus(event: PaymentProcessedEvent): void
        -sendPaymentConfirmation(event: PaymentProcessedEvent): void
        -logPaymentAudit(event: PaymentProcessedEvent): void
    }
}

package "資料同步 (Data Synchronization)" {
    
    class ReadModelUpdater {
        -customerSummaryRepository: CustomerSummaryViewRepository
        -orderSummaryRepository: OrderSummaryViewRepository
        -productCatalogRepository: ProductCatalogViewRepository
        --
        +updateCustomerSummary(event: CustomerRegisteredEvent): void
        +updateOrderSummary(event: OrderCreatedEvent): void
        +updateProductCatalog(event: ProductUpdatedEvent): void
    }
    
    class DataSynchronizer {
        -sourceDatabase: DataSource
        -targetDatabase: DataSource
        -changeDetector: ChangeDetector
        --
        +synchronizeData(): void
        +synchronizeTable(tableName: String): void
        -detectChanges(tableName: String): List<DataChange>
        -applyChanges(changes: List<DataChange>): void
    }
    
    class ChangeDataCapture {
        -debeziumConnector: DebeziumConnector
        -eventPublisher: EventPublisher
        --
        +startCapture(): void
        +stopCapture(): void
        -processChange(change: DatabaseChange): void
        -publishChangeEvent(change: DatabaseChange): void
    }
}

package "資料驗證 (Data Validation)" {
    
    class DataValidationService {
        -validationRules: List<ValidationRule>
        --
        +validateCustomerData(customer: CustomerEntity): ValidationResult
        +validateOrderData(order: OrderEntity): ValidationResult
        +validateProductData(product: ProductEntity): ValidationResult
        -applyValidationRules(data: Object, rules: List<ValidationRule>): ValidationResult
    }
    
    interface ValidationRule {
        +validate(data: Object): ValidationResult
        +getErrorMessage(): String
    }
    
    class EmailValidationRule {
        -emailPattern: Pattern
        --
        +validate(data: Object): ValidationResult
        +getErrorMessage(): String
        -isValidEmail(email: String): boolean
    }
    
    class BusinessRuleValidationRule {
        -businessRuleEngine: BusinessRuleEngine
        --
        +validate(data: Object): ValidationResult
        +getErrorMessage(): String
        -evaluateBusinessRules(data: Object): boolean
    }
}

' 關係定義
DomainEvent <|-- CustomerRegisteredEvent
DomainEvent <|-- OrderCreatedEvent
DomainEvent <|-- PaymentProcessedEvent

EventStore <|-- JpaEventStore
EventStore <|-- EventStoreDbAdapter

CustomerRepository <|-- JpaCustomerRepository
OrderRepository <|-- JpaOrderRepository
OrderRepository <|-- EventSourcedOrderRepository

AbstractDomainEventHandler <|-- CustomerRegisteredEventHandler
AbstractDomainEventHandler <|-- OrderCreatedEventHandler
AbstractDomainEventHandler <|-- PaymentProcessedEventHandler

ValidationRule <|-- EmailValidationRule
ValidationRule <|-- BusinessRuleValidationRule

DomainEventPublisher --> EventStore : 使用
DomainEventPublisher --> DomainEvent : 發布

CustomerRegisteredEventHandler --> CustomerSummaryView : 創建
OrderCreatedEventHandler --> OrderSummaryView : 創建
PaymentProcessedEventHandler --> OrderEntity : 更新

CustomerQueryService --> CustomerSummaryView : 查詢
OrderQueryService --> OrderSummaryView : 查詢
ProductQueryService --> ProductCatalogView : 查詢

ReadModelUpdater --> CustomerSummaryView : 更新
ReadModelUpdater --> OrderSummaryView : 更新
ReadModelUpdater --> ProductCatalogView : 更新

DataValidationService --> ValidationRule : 使用
DataValidationService --> CustomerEntity : 驗證
DataValidationService --> OrderEntity : 驗證

' 樣式定義
skinparam class {
    BackgroundColor<<DomainEvent>> Lavender
    BorderColor<<DomainEvent>> Purple
    
    BackgroundColor<<Entity>> LightBlue
    BorderColor<<Entity>> Blue
    
    BackgroundColor<<QueryModel>> LightGreen
    BorderColor<<QueryModel>> Green
    
    BackgroundColor<<Repository>> LightYellow
    BorderColor<<Repository>> Orange
    
    BackgroundColor<<Service>> LightPink
    BorderColor<<Service>> Red
    
    BackgroundColor<<EventHandler>> LightCyan
    BorderColor<<EventHandler>> DarkCyan
    
    BackgroundColor<<Validation>> LightGray
    BorderColor<<Validation>> Gray
}

@enduml