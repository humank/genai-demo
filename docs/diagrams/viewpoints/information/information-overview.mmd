graph TB
    subgraph "資料來源 (Data Sources)"
        USER[使用者輸入<br/>User Input]
        EXT[外部系統<br/>External Systems]
        BATCH[批次處理<br/>Batch Processing]
    end
    
    subgraph "資料擷取層 (Data Ingestion Layer)"
        API[REST API<br/>資料接收]
        MSG[訊息佇列<br/>Message Queue]
        ETL[ETL 處理<br/>Extract Transform Load]
    end
    
    subgraph "領域事件系統 (Domain Event System)"
        subgraph "事件發布 (Event Publishing)"
            EP[事件發布器<br/>Event Publisher]
            EB[事件匯流排<br/>Event Bus]
        end
        
        subgraph "事件存儲 (Event Store)"
            ES[(Event Store<br/>事件存儲)]
            ESH[事件存儲處理器<br/>Event Store Handler]
        end
        
        subgraph "事件處理 (Event Processing)"
            EH1[客戶事件處理器<br/>Customer Event Handler]
            EH2[訂單事件處理器<br/>Order Event Handler]
            EH3[支付事件處理器<br/>Payment Event Handler]
        end
    end
    
    subgraph "資料模型層 (Data Model Layer)"
        subgraph "寫模型 (Write Models)"
            WM1[客戶聚合<br/>Customer Aggregate]
            WM2[訂單聚合<br/>Order Aggregate]
            WM3[產品聚合<br/>Product Aggregate]
        end
        
        subgraph "讀模型 (Read Models)"
            RM1[客戶摘要視圖<br/>Customer Summary View]
            RM2[訂單摘要視圖<br/>Order Summary View]
            RM3[產品目錄視圖<br/>Product Catalog View]
        end
    end
    
    subgraph "資料存儲層 (Data Storage Layer)"
        subgraph "主資料庫 (Primary Database)"
            PDB[(PostgreSQL<br/>主資料庫)]
        end
        
        subgraph "讀取資料庫 (Read Database)"
            RDB[(PostgreSQL<br/>讀取副本)]
        end
        
        subgraph "快取層 (Cache Layer)"
            REDIS[(Redis<br/>快取)]
            MEMCACHE[(Memcached<br/>分散式快取)]
        end
        
        subgraph "搜尋引擎 (Search Engine)"
            ES_SEARCH[(Elasticsearch<br/>全文搜尋)]
        end
    end
    
    subgraph "資料處理層 (Data Processing Layer)"
        subgraph "即時處理 (Real-time Processing)"
            STREAM[串流處理<br/>Stream Processing]
            CEP[複雜事件處理<br/>Complex Event Processing]
        end
        
        subgraph "批次處理 (Batch Processing)"
            BATCH_PROC[批次處理器<br/>Batch Processor]
            SCHEDULER[排程器<br/>Scheduler]
        end
        
        subgraph "資料同步 (Data Synchronization)"
            SYNC[資料同步器<br/>Data Synchronizer]
            CDC[變更資料擷取<br/>Change Data Capture]
        end
    end
    
    subgraph "資料服務層 (Data Service Layer)"
        subgraph "查詢服務 (Query Services)"
            QS1[客戶查詢服務<br/>Customer Query Service]
            QS2[訂單查詢服務<br/>Order Query Service]
            QS3[產品查詢服務<br/>Product Query Service]
        end
        
        subgraph "報表服務 (Reporting Services)"
            RS1[業務報表服務<br/>Business Report Service]
            RS2[分析服務<br/>Analytics Service]
            RS3[儀表板服務<br/>Dashboard Service]
        end
    end
    
    subgraph "資料消費者 (Data Consumers)"
        WEB[Web 應用<br/>Web Application]
        MOBILE[行動應用<br/>Mobile App]
        BI[商業智慧<br/>Business Intelligence]
        REPORT[報表系統<br/>Reporting System]
    end
    
    %% 資料流連接
    USER --> API
    EXT --> MSG
    BATCH --> ETL
    
    API --> EP
    MSG --> EP
    ETL --> EP
    
    EP --> EB
    EB --> ESH
    ESH --> ES
    
    EB --> EH1
    EB --> EH2
    EB --> EH3
    
    EH1 --> WM1
    EH2 --> WM2
    EH3 --> WM3
    
    WM1 --> PDB
    WM2 --> PDB
    WM3 --> PDB
    
    %% 讀模型更新
    EH1 --> RM1
    EH2 --> RM2
    EH3 --> RM3
    
    RM1 --> RDB
    RM2 --> RDB
    RM3 --> RDB
    
    %% 快取更新
    RM1 --> REDIS
    RM2 --> REDIS
    RM3 --> REDIS
    
    %% 搜尋索引更新
    RM1 --> ES_SEARCH
    RM2 --> ES_SEARCH
    RM3 --> ES_SEARCH
    
    %% 資料處理
    PDB --> CDC
    CDC --> STREAM
    STREAM --> CEP
    
    PDB --> SYNC
    SYNC --> RDB
    
    SCHEDULER --> BATCH_PROC
    BATCH_PROC --> PDB
    
    %% 查詢服務
    QS1 --> RDB
    QS1 --> REDIS
    QS1 --> ES_SEARCH
    
    QS2 --> RDB
    QS2 --> REDIS
    
    QS3 --> RDB
    QS3 --> MEMCACHE
    QS3 --> ES_SEARCH
    
    %% 報表服務
    RS1 --> RDB
    RS2 --> RDB
    RS3 --> REDIS
    
    %% 資料消費
    WEB --> QS1
    WEB --> QS2
    WEB --> QS3
    
    MOBILE --> QS1
    MOBILE --> QS2
    
    BI --> RS1
    BI --> RS2
    
    REPORT --> RS1
    REPORT --> RS3
    
    %% 樣式定義
    classDef source fill:#e8f5e8,stroke:#4caf50,stroke-width:2px
    classDef ingestion fill:#e3f2fd,stroke:#2196f3,stroke-width:2px
    classDef event fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px
    classDef model fill:#fff3e0,stroke:#ff9800,stroke-width:2px
    classDef storage fill:#fafafa,stroke:#607d8b,stroke-width:2px
    classDef processing fill:#ffebee,stroke:#d32f2f,stroke-width:2px
    classDef service fill:#e8f5e8,stroke:#4caf50,stroke-width:2px
    classDef consumer fill:#e1f5fe,stroke:#00bcd4,stroke-width:2px
    
    class USER,EXT,BATCH source
    class API,MSG,ETL ingestion
    class EP,EB,ES,ESH,EH1,EH2,EH3 event
    class WM1,WM2,WM3,RM1,RM2,RM3 model
    class PDB,RDB,REDIS,MEMCACHE,ES_SEARCH storage
    class STREAM,CEP,BATCH_PROC,SCHEDULER,SYNC,CDC processing
    class QS1,QS2,QS3,RS1,RS2,RS3 service
    class WEB,MOBILE,BI,REPORT consumer