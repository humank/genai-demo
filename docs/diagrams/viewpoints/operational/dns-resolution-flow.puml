@startuml DNS Resolution Flow
!define AWSPUML https://raw.githubusercontent.com/awslabs/aws-icons-for-plantuml/v18.0/dist
!includeurl AWSPUML/AWSCommon.puml
!includeurl AWSPUML/AWSSimplified.puml
!includeurl AWSPUML/NetworkingContentDelivery/all.puml
!includeurl AWSPUML/Compute/all.puml

title DNS Resolution Flow - genai-demo.kimkao.io

skinparam backgroundColor #FFFFFF
skinparam sequenceMessageAlign center
skinparam sequenceReferenceAlign center

actor "User Browser" as user
participant "Local DNS\nResolver" as local_dns
participant "Root DNS\nServer" as root_dns
participant ".io TLD\nServer" as tld_dns
participant "Route 53\nkimkao.io" as route53
participant "Health Check\nSystem" as health_check
participant "CloudFront\nCDN" as cloudfront
participant "Primary ALB\n(ap-east-2)" as primary_alb
participant "Secondary ALB\n(ap-northeast-1)" as secondary_alb
participant "EKS Cluster\ngenai-demo-app" as eks

== Normal DNS Resolution Flow ==

user -> local_dns : 1. DNS Query\ngenai-demo.kimkao.io
activate local_dns

alt Cache Miss
    local_dns -> root_dns : 2. Query Root Server
    activate root_dns
    root_dns -> local_dns : 3. Return .io TLD Server
    deactivate root_dns
    
    local_dns -> tld_dns : 4. Query .io TLD
    activate tld_dns
    tld_dns -> local_dns : 5. Return Route 53 NS
    deactivate tld_dns
end

local_dns -> route53 : 6. Query genai-demo.kimkao.io
activate route53

route53 -> health_check : 7. Check Health Status
activate health_check
health_check -> primary_alb : 8. Health Check Request\n/actuator/health
activate primary_alb
primary_alb -> eks : 9. Forward Health Check
activate eks
eks -> primary_alb : 10. Return 200 OK
deactivate eks
primary_alb -> health_check : 11. Return Healthy Status
deactivate primary_alb
health_check -> route53 : 12. Primary Region: HEALTHY
deactivate health_check

route53 -> local_dns : 13. Return Primary ALB IP\n(ap-east-2)\nTTL: 60s
deactivate route53

local_dns -> user : 14. Return Resolved IP\nTTL: 60s
deactivate local_dns

== User Request Flow ==

user -> cloudfront : 15. HTTPS Request\ngenai-demo.kimkao.io
activate cloudfront
cloudfront -> primary_alb : 16. Forward to Origin\n(ap-east-2 ALB)
activate primary_alb
primary_alb -> eks : 17. Load Balance to Pod
activate eks
eks -> primary_alb : 18. Return Application Response
deactivate eks
primary_alb -> cloudfront : 19. Return HTTP Response
deactivate primary_alb
cloudfront -> user : 20. Return Final Response\n(with CDN caching)
deactivate cloudfront

note over user, eks
  **Normal Flow Characteristics:**
  - Total DNS resolution: 50-200ms
  - Health check interval: 30 seconds
  - TTL: 60 seconds for fast failover
  - CDN caching: Reduces origin load
end note

== Failover Scenario ==

group Failure Detection
    health_check -> primary_alb : Health Check Request
    activate health_check
    activate primary_alb
    primary_alb -> health_check : Timeout/5xx Error
    deactivate primary_alb
    
    health_check -> primary_alb : Retry (2nd attempt)
    activate primary_alb
    primary_alb -> health_check : Timeout/5xx Error
    deactivate primary_alb
    
    health_check -> primary_alb : Retry (3rd attempt)
    activate primary_alb
    primary_alb -> health_check : Timeout/5xx Error
    deactivate primary_alb
    
    note over health_check : 3 consecutive failures\nTrigger failover
    deactivate health_check
end

group Automatic Failover
    route53 -> health_check : Check Secondary Health
    activate route53
    activate health_check
    health_check -> secondary_alb : Health Check Request
    activate secondary_alb
    secondary_alb -> health_check : 200 OK (Healthy)
    deactivate secondary_alb
    health_check -> route53 : Secondary Region: HEALTHY
    deactivate health_check
    
    route53 -> route53 : Update DNS Record\nPrimary → Secondary
    note over route53 : DNS failover completed\nNew queries return secondary IP
    deactivate route53
end

group User Experience During Failover
    user -> local_dns : DNS Query (cache expired)
    activate local_dns
    local_dns -> route53 : Query genai-demo.kimkao.io
    activate route53
    route53 -> local_dns : Return Secondary ALB IP\n(ap-northeast-1)
    deactivate route53
    local_dns -> user : Return New IP
    deactivate local_dns
    
    user -> cloudfront : HTTPS Request
    activate cloudfront
    cloudfront -> secondary_alb : Forward to Secondary Origin
    activate secondary_alb
    secondary_alb -> user : Service continues normally
    deactivate secondary_alb
    deactivate cloudfront
end

note over user, secondary_alb
  **Failover Characteristics:**
  - Detection time: 90 seconds (3 × 30s)
  - DNS propagation: 60 seconds (TTL)
  - Total failover time: < 5 minutes
  - User experience: Minimal disruption
end note

@enduml