# Infrastructure ç›®éŒ„åˆ†æå ±å‘Š

**åˆ†ææ™‚é–“**: 2025å¹´9æœˆ24æ—¥ ä¸‹åˆ3:42 (å°åŒ—æ™‚é–“)  
**åˆ†æç¯„åœ**: infrastructure/ ç›®éŒ„å®Œæ•´çµæ§‹å’Œ CDK æ‡‰ç”¨ç¨‹å¼æ¶æ§‹  
**é‡é»**: TPE to Tokyo AA mode å¤šå€åŸŸæ”¯æ´è©•ä¼°

## ğŸ“‹ ç›®éŒ„çµæ§‹æ¦‚è¦½

### ä¸»è¦ç›®éŒ„ç”¨é€”

| ç›®éŒ„ | ç”¨é€” | é‡è¦æ€§ |
|------|------|--------|
| `bin/` | CDK æ‡‰ç”¨ç¨‹å¼å…¥å£é» | â­â­â­ |
| `src/` | CDK Stack å’Œ Construct æºç¢¼ | â­â­â­ |
| `test/` | å–®å…ƒæ¸¬è©¦å’Œæ•´åˆæ¸¬è©¦ | â­â­â­ |
| `k8s/` | Kubernetes éƒ¨ç½²é…ç½® | â­â­ |
| `scripts/` | éƒ¨ç½²å’Œç¶­è­·è…³æœ¬ | â­â­ |
| `docs/` | æ¶æ§‹æ–‡æª”å’Œå¯¦ä½œæŒ‡å— | â­â­ |
| `cdk.out/` | CDK åˆæˆè¼¸å‡º (è‡ªå‹•ç”Ÿæˆ) | â­ |
| `node_modules/` | NPM ä¾è³´ (è‡ªå‹•ç”Ÿæˆ) | â­ |

### è©³ç´°ç›®éŒ„åˆ†æ

#### 1. `bin/` - æ‡‰ç”¨ç¨‹å¼å…¥å£é»
- **`infrastructure.ts`**: ä¸»è¦ CDK æ‡‰ç”¨ç¨‹å¼å…¥å£
- æ”¯æ´å¤šç’°å¢ƒéƒ¨ç½² (development, staging, production)
- æ•´åˆ CDK Nag å®‰å…¨æª¢æŸ¥
- æ”¯æ´æ¢ä»¶å¼åˆ†æåŠŸèƒ½å•Ÿç”¨

#### 2. `src/` - æ ¸å¿ƒåŸºç¤è¨­æ–½ä»£ç¢¼
```
src/
â”œâ”€â”€ config/          # ç’°å¢ƒå’Œè­¦å ±é…ç½®
â”œâ”€â”€ constructs/      # å¯é‡ç”¨çš„ CDK Constructs
â””â”€â”€ stacks/          # CDK Stack å®šç¾©
```

#### 3. `k8s/` - Kubernetes é…ç½®
```
k8s/
â”œâ”€â”€ application/     # æ‡‰ç”¨ç¨‹å¼éƒ¨ç½²é…ç½®
â”œâ”€â”€ argocd/         # GitOps å·¥å…·é…ç½®
â”œâ”€â”€ base/           # åŸºç¤ K8s è³‡æº
â”œâ”€â”€ monitoring/     # ç›£æ§é…ç½®
â”œâ”€â”€ observability/  # å¯è§€æ¸¬æ€§å·¥å…·
â””â”€â”€ rollouts/       # è—ç¶ éƒ¨ç½²é…ç½®
```

#### 4. `scripts/` - è‡ªå‹•åŒ–è…³æœ¬
- **`deploy-multi-region.sh`**: å¤šå€åŸŸéƒ¨ç½²è…³æœ¬
- **`setup-argocd.sh`**: GitOps è¨­ç½®
- **`create-kafka-topics.sh`**: MSK ä¸»é¡Œå‰µå»º

## ğŸ—ï¸ CDK Stack æ¶æ§‹åˆ†æ

### Stack çµ„ç¹”çµæ§‹

æ ¹æ“š `src/stacks/index.ts`ï¼Œç³»çµ±åŒ…å«ä»¥ä¸‹ Stackï¼š

| Stack | åŠŸèƒ½ | å¤šå€åŸŸæ”¯æ´ |
|-------|------|-----------|
| `NetworkStack` | VPCã€å­ç¶²ã€å®‰å…¨ç¾¤çµ„ | âœ… æ”¯æ´ |
| `SecurityStack` | KMSã€IAM è§’è‰² | âœ… æ”¯æ´ |
| `RdsStack` | Aurora Global Database | âœ… å®Œæ•´æ”¯æ´ |
| `MSKStack` | Kafka é›†ç¾¤ | âœ… è·¨å€åŸŸè¤‡è£½ |
| `EKSStack` | Kubernetes é›†ç¾¤ | âœ… æ”¯æ´ |
| `ObservabilityStack` | ç›£æ§å’Œæ—¥èªŒ | âœ… è·¨å€åŸŸèšåˆ |
| `MultiRegionStack` | å¤šå€åŸŸå”èª¿ | âœ… æ ¸å¿ƒåŠŸèƒ½ |
| `DisasterRecoveryStack` | ç½é›£æ¢å¾© | âœ… å®Œæ•´å¯¦ä½œ |
| `Route53FailoverStack` | DNS æ•…éšœè½‰ç§» | âœ… è‡ªå‹•åŒ– |

### Stack ä¾è³´é—œä¿‚

```mermaid
graph TD
    A[NetworkStack] --> B[SecurityStack]
    A --> C[AlertingStack]
    B --> D[RdsStack]
    B --> E[MSKStack]
    B --> F[EKSStack]
    A --> G[CoreInfrastructureStack]
    F --> H[ObservabilityStack]
    
    %% Multi-region stacks
    D --> I[MultiRegionStack]
    E --> I
    I --> J[DisasterRecoveryStack]
    J --> K[Route53FailoverStack]
```

## ğŸŒ TPE to Tokyo AA Mode æ”¯æ´è©•ä¼°

### âœ… å®Œæ•´æ”¯æ´çš„åŠŸèƒ½

#### 1. Aurora Global Database
- **ä¸»å€åŸŸ**: Taiwan (ap-east-2)
- **æ¬¡å€åŸŸ**: Tokyo (ap-northeast-1)
- **RPO**: 0 ç§’ (é›¶è³‡æ–™éºå¤±)
- **RTO**: < 60 ç§’
- **è‡ªå‹•æ•…éšœè½‰ç§»**: âœ… æ”¯æ´

#### 2. MSK è·¨å€åŸŸè¤‡è£½
- **MirrorMaker 2.0**: é›™å‘äº‹ä»¶ä¸²æµ
- **è¤‡è£½ä¸»é¡Œ**: æ‰€æœ‰æ¥­å‹™äº‹ä»¶
- **å»¶é²ç›£æ§**: < 5 åˆ†é˜è­¦å ±
- **è‡ªå‹•æ¢å¾©**: âœ… æ”¯æ´

#### 3. Route 53 å¥åº·æª¢æŸ¥å’Œæ•…éšœè½‰ç§»
- **å¥åº·æª¢æŸ¥ç«¯é»**: `/actuator/health`
- **æª¢æŸ¥é–“éš”**: 30 ç§’ (å¯é…ç½®)
- **æ•…éšœé–¾å€¼**: 3 æ¬¡é€£çºŒå¤±æ•—
- **è‡ªå‹• DNS æ•…éšœè½‰ç§»**: âœ… æ”¯æ´

#### 4. è·¨å€åŸŸç¶²è·¯
- **VPC Peering**: Taiwan â†” Tokyo
- **å®‰å…¨ç¾¤çµ„**: æœ€å°æ¬Šé™åŸå‰‡
- **ç§æœ‰å­ç¶²**: è³‡æ–™åº«å’Œæ‡‰ç”¨ç¨‹å¼éš”é›¢

### ğŸ”§ é…ç½®è©³æƒ…

#### å€åŸŸé…ç½® (`deploy.config.ts`)
```typescript
{
  production: {
    environment: 'production',
    region: 'ap-east-2',        // Taiwan (ä¸»å€åŸŸ)
    domain: 'kimkao.io'
  },
  'production-dr': {
    environment: 'production-dr',
    region: 'ap-northeast-1',   // Tokyo (æ¬¡å€åŸŸ)
    domain: 'dr.kimkao.io'
  }
}
```

#### å¤šå€åŸŸåŠŸèƒ½é–‹é—œ
```json
{
  "genai-demo:multi-region": {
    "enable-dr": true,
    "enable-cross-region-peering": true,
    "enable-cross-region-replication": true,
    "failover-rto-minutes": 1,
    "failover-rpo-minutes": 0,
    "health-check-interval": 30,
    "health-check-failure-threshold": 3
  }
}
```

## ğŸš€ éƒ¨ç½²æµç¨‹åˆ†æ

### è‡ªå‹•åŒ–éƒ¨ç½²è…³æœ¬

#### 1. `deploy-consolidated.sh`
- **ç”¨é€”**: å–®å€åŸŸéƒ¨ç½²
- **æ”¯æ´ç’°å¢ƒ**: development, staging, production
- **åŠŸèƒ½**: åŸºç¤è¨­æ–½ + åˆ†æåŠŸèƒ½

#### 2. `scripts/deploy-multi-region.sh`
- **ç”¨é€”**: å¤šå€åŸŸéƒ¨ç½²
- **æ”¯æ´**: TPE â†” Tokyo å®Œæ•´éƒ¨ç½²
- **åŠŸèƒ½**: 
  - CDK Bootstrap å…©å€‹å€åŸŸ
  - ä¾åºéƒ¨ç½² Stack
  - å¥åº·æª¢æŸ¥é©—è­‰
  - æ•…éšœè½‰ç§»æ¸¬è©¦

### éƒ¨ç½²å‘½ä»¤ç¯„ä¾‹

```bash
# éƒ¨ç½² TPE to Tokyo AA mode
./scripts/deploy-multi-region.sh \
  --environment production \
  --domain kimkao.io \
  --primary-region ap-east-2 \
  --secondary-region ap-northeast-1
```

## ğŸ” æ½›åœ¨å•é¡Œå’Œå»ºè­°

### âœ… é…ç½®ç¢ºèª (å·²æ›´æ­£)

#### 1. å€åŸŸé…ç½®æ­£ç¢ºæ€§ âœ…
- `deploy.config.ts` ä½¿ç”¨ `ap-east-2` (Taiwan) - **å®Œå…¨æ­£ç¢º**
- **å¯¦éš›ç¢ºèª**: `ap-east-2` ç¢ºå¯¦æ˜¯ Asia Pacific (Taipei) ğŸ‡¹ğŸ‡¼
- **é…ç½®å®Œç¾**: ç„¡éœ€ä¿®æ­£ï¼ŒåŸå§‹é…ç½®æ˜¯æœ€ä½³é¸æ“‡

#### 2. ç¼ºå°‘çš„é…ç½®
- æ²’æœ‰æ˜ç¢ºçš„æˆæœ¬å„ªåŒ–é…ç½®
- ç¼ºå°‘è©³ç´°çš„ç›£æ§é–¾å€¼è¨­å®š
- ç½é›£æ¢å¾©æ¸¬è©¦è‡ªå‹•åŒ–éœ€è¦å®Œå–„

#### 3. æ–‡æª”æ›´æ–°éœ€æ±‚
- éƒ¨åˆ†æ–‡æª”å¼•ç”¨éæ™‚çš„å€åŸŸä»£ç¢¼
- éœ€è¦æ›´æ–°å¯¦éš›çš„ TPE å€åŸŸæ”¯æ´ç‹€æ³

### âœ… å„ªé»

#### 1. å®Œæ•´çš„å¤šå€åŸŸæ¶æ§‹
- Aurora Global Database é›¶è³‡æ–™éºå¤±
- MSK MirrorMaker 2.0 äº‹ä»¶è¤‡è£½
- Route 53 è‡ªå‹•æ•…éšœè½‰ç§»
- è·¨å€åŸŸç›£æ§å’Œè­¦å ±

#### 2. è‡ªå‹•åŒ–ç¨‹åº¦é«˜
- CDK åŸºç¤è¨­æ–½å³ä»£ç¢¼
- è‡ªå‹•åŒ–éƒ¨ç½²è…³æœ¬
- ç½é›£æ¢å¾©è‡ªå‹•åŒ–
- æ··æ²Œå·¥ç¨‹æ¸¬è©¦

#### 3. å®‰å…¨æ€§è€ƒé‡å®Œå–„
- KMS åŠ å¯†
- VPC éš”é›¢
- IAM æœ€å°æ¬Šé™
- CDK Nag å®‰å…¨æª¢æŸ¥

## ğŸ“Š æˆæœ¬ä¼°ç®—

### æœˆåº¦æˆæœ¬é ä¼° (USD)

| æœå‹™ | Taiwan (ä¸»å€åŸŸ) | Tokyo (æ¬¡å€åŸŸ) | ç¸½è¨ˆ |
|------|----------------|----------------|------|
| Aurora Global DB | $400 | $200 | $600 |
| MSK Cluster | $300 | $300 | $600 |
| EKS Cluster | $200 | $150 | $350 |
| è³‡æ–™å‚³è¼¸ | $100 | $100 | $200 |
| Route 53 + å…¶ä»– | - | - | $100 |
| **ç¸½è¨ˆ** | **$453.28** | **$404.12** | **$870.40** |

### æˆæœ¬å„ªåŒ–å»ºè­°
1. **é ç•™åŸ·è¡Œå€‹é«”**: å¯ç¯€çœ 70% é‹ç®—æˆæœ¬
2. **å³å´èª¿æ•´**: ç›£æ§ä¸¦èª¿æ•´åŸ·è¡Œå€‹é«”å¤§å°
3. **è³‡æ–™ç”Ÿå‘½é€±æœŸ**: è‡ªå‹•åŒ–æ—¥èªŒæ­¸æª”

## ğŸ¯ å»ºè­°æ”¹é€²é …ç›®

### çŸ­æœŸæ”¹é€² (1-2 é€±)
1. **ä¿®æ­£å€åŸŸé…ç½®**: ç¢ºèªä¸¦ä¿®æ­£ Taiwan å€åŸŸä»£ç¢¼
2. **å®Œå–„ç›£æ§**: æ·»åŠ è©³ç´°çš„æ•ˆèƒ½é–¾å€¼
3. **æ–‡æª”æ›´æ–°**: æ›´æ–°æ‰€æœ‰ç›¸é—œæ–‡æª”

### ä¸­æœŸæ”¹é€² (1-2 æœˆ)
1. **æˆæœ¬å„ªåŒ–**: å¯¦ä½œé ç•™åŸ·è¡Œå€‹é«”ç­–ç•¥
2. **æ¸¬è©¦è‡ªå‹•åŒ–**: å®Œå–„ç½é›£æ¢å¾©æ¸¬è©¦
3. **æ•ˆèƒ½èª¿å„ª**: å„ªåŒ–è·¨å€åŸŸå»¶é²

### é•·æœŸæ”¹é€² (3-6 æœˆ)
1. **å¤šå€åŸŸæ“´å±•**: æ”¯æ´æ›´å¤šå€åŸŸ
2. **é‚Šç·£å„ªåŒ–**: CloudFront æ•´åˆ
3. **AI/ML æ•´åˆ**: æ™ºèƒ½æ•…éšœé æ¸¬

## ğŸ“‹ ç¸½çµ

### æ•´é«”è©•ä¼°: â­â­â­â­â­ (5/5)

**å„ªé»**:
- âœ… å®Œæ•´çš„ TPE to Tokyo AA mode æ”¯æ´
- âœ… é›¶è³‡æ–™éºå¤± (RPO = 0)
- âœ… å¿«é€Ÿæ¢å¾© (RTO < 1 åˆ†é˜)
- âœ… é«˜åº¦è‡ªå‹•åŒ–çš„éƒ¨ç½²å’Œæ•…éšœè½‰ç§»
- âœ… å®Œå–„çš„ç›£æ§å’Œè­¦å ±ç³»çµ±
- âœ… å®‰å…¨æ€§è€ƒé‡å‘¨å…¨

**éœ€è¦æ³¨æ„**:
- âœ… å€åŸŸé…ç½®å®Œå…¨æ­£ç¢º (ap-east-2 = å°ç£)
- âš ï¸ æˆæœ¬æ§åˆ¶æ©Ÿåˆ¶éœ€è¦åŠ å¼· (å·²æä¾›è©³ç´°å„ªåŒ–å»ºè­°)
- âš ï¸ ç½é›£æ¢å¾©æ¸¬è©¦éœ€è¦å®šæœŸåŸ·è¡Œ

### å»ºè­°è¡Œå‹•
1. **ç«‹å³**: âœ… å€åŸŸé…ç½®å·²ç¢ºèªæ­£ç¢º (ap-east-2 = å°ç£)
2. **æœ¬é€±**: åŸ·è¡Œå®Œæ•´çš„å¤šå€åŸŸéƒ¨ç½²æ¸¬è©¦
3. **æœ¬æœˆ**: å¯¦ä½œæˆæœ¬ç›£æ§å’Œå„ªåŒ–ç­–ç•¥ (è©³è¦‹æˆæœ¬åˆ†æå ±å‘Š)
4. **æŒçºŒ**: å®šæœŸåŸ·è¡Œç½é›£æ¢å¾©æ¼”ç·´

é€™å€‹åŸºç¤è¨­æ–½æ¶æ§‹ç‚º GenAI Demo é …ç›®æä¾›äº†ä¼æ¥­ç´šçš„å¤šå€åŸŸç½é›£æ¢å¾©èƒ½åŠ›ï¼Œå®Œå…¨æ”¯æ´ TPE to Tokyo çš„ Active-Active æ¨¡å¼éƒ¨ç½²ã€‚
