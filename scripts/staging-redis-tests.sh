#!/bin/bash\n\n# Staging Redis Integration Tests\n# é€™å€‹è…³æœ¬åœ¨ Staging ç’°å¢ƒä¸­æ¸¬è©¦ Redis/ElastiCache æ•´åˆ\n\nset -e  # é‡åˆ°éŒ¯èª¤ç«‹å³é€€å‡º\n\necho \"ğŸ”§ Setting up Staging Redis Integration Tests...\"\n\n# æª¢æŸ¥å¿…è¦çš„ç’°å¢ƒè®Šæ•¸\nrequired_vars=(\"STAGING_REDIS_CLUSTER_NODES\" \"STAGING_APP_URL\")\nfor var in \"${required_vars[@]}\"; do\n    if [ -z \"${!var}\" ]; then\n        echo \"âŒ Error: Environment variable $var is not set\"\n        exit 1\n    fi\ndone\n\n# è¨­å®šæ¸¬è©¦ç’°å¢ƒ\nexport SPRING_PROFILES_ACTIVE=staging\nexport REDIS_MODE=CLUSTER\nexport REDIS_CLUSTER_NODES=${STAGING_REDIS_CLUSTER_NODES}\nexport REDIS_PASSWORD=${STAGING_REDIS_PASSWORD:-}\n\necho \"ğŸ“‹ Environment Configuration:\"\necho \"  Profile: $SPRING_PROFILES_ACTIVE\"\necho \"  Redis Mode: $REDIS_MODE\"\necho \"  Redis Nodes: $REDIS_CLUSTER_NODES\"\necho \"  App URL: $STAGING_APP_URL\"\necho \"\"\n\n# æ¸¬è©¦å‡½æ•¸\ntest_redis_connectivity() {\n    echo \"ğŸ” Testing Redis connectivity...\"\n    \n    # æª¢æŸ¥æ‡‰ç”¨ç¨‹å¼å¥åº·ç‹€æ…‹\n    if curl -f -s \"$STAGING_APP_URL/actuator/health\" > /dev/null; then\n        echo \"âœ… Application is healthy\"\n    else\n        echo \"âŒ Application health check failed\"\n        return 1\n    fi\n    \n    # æª¢æŸ¥ Redis ç‰¹å®šçš„å¥åº·ç‹€æ…‹ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰\n    if curl -f -s \"$STAGING_APP_URL/actuator/health/redis\" > /dev/null 2>&1; then\n        echo \"âœ… Redis health check passed\"\n    else\n        echo \"âš ï¸  Redis health endpoint not available (this is expected if not implemented)\"\n    fi\n}\n\ntest_distributed_locks() {\n    echo \"ğŸ”’ Testing distributed lock operations...\"\n    \n    local test_key=\"staging-test-lock-$(date +%s)\"\n    \n    # æ¸¬è©¦é–ç²å–ï¼ˆé€šé REST APIï¼‰\n    echo \"  Testing lock acquisition...\"\n    local lock_response\n    lock_response=$(curl -s -X POST \"$STAGING_APP_URL/api/test/locks/$test_key/acquire\" \\\n        -H \"Content-Type: application/json\" \\\n        -d '{\"waitTime\": 5, \"leaseTime\": 30, \"timeUnit\": \"SECONDS\"}' || echo \"FAILED\")\n    \n    if [[ \"$lock_response\" == *\"true\"* ]] || [[ \"$lock_response\" == *\"success\"* ]]; then\n        echo \"  âœ… Lock acquisition successful\"\n    else\n        echo \"  âš ï¸  Lock acquisition test skipped (API endpoint may not be implemented)\"\n        return 0\n    fi\n    \n    # æ¸¬è©¦é–ç‹€æ…‹æŸ¥è©¢\n    echo \"  Testing lock status query...\"\n    local status_response\n    status_response=$(curl -s \"$STAGING_APP_URL/api/test/locks/$test_key/status\" || echo \"FAILED\")\n    \n    if [[ \"$status_response\" == *\"true\"* ]] || [[ \"$status_response\" == *\"locked\"* ]]; then\n        echo \"  âœ… Lock status query successful\"\n    else\n        echo \"  âš ï¸  Lock status query test skipped\"\n    fi\n    \n    # æ¸¬è©¦é–é‡‹æ”¾\n    echo \"  Testing lock release...\"\n    local release_response\n    release_response=$(curl -s -X DELETE \"$STAGING_APP_URL/api/test/locks/$test_key\" || echo \"FAILED\")\n    \n    echo \"  âœ… Lock release test completed\"\n}\n\ntest_concurrent_locks() {\n    echo \"ğŸ”„ Testing concurrent lock operations...\"\n    \n    local test_key=\"staging-concurrent-test-$(date +%s)\"\n    local pids=()\n    local success_count=0\n    \n    # å•Ÿå‹•å¤šå€‹ä¸¦ç™¼è«‹æ±‚\n    for i in {1..5}; do\n        {\n            response=$(curl -s -X POST \"$STAGING_APP_URL/api/test/locks/$test_key/acquire\" \\\n                -H \"Content-Type: application/json\" \\\n                -d '{\"waitTime\": 1, \"leaseTime\": 5, \"timeUnit\": \"SECONDS\"}' 2>/dev/null || echo \"FAILED\")\n            \n            if [[ \"$response\" == *\"true\"* ]] || [[ \"$response\" == *\"success\"* ]]; then\n                echo \"  Process $i: Lock acquired\"\n                sleep 1\n                curl -s -X DELETE \"$STAGING_APP_URL/api/test/locks/$test_key\" >/dev/null 2>&1\n                echo \"  Process $i: Lock released\"\n            else\n                echo \"  Process $i: Lock acquisition failed (expected in concurrent test)\"\n            fi\n        } &\n        pids+=(\"$!\")\n    done\n    \n    # ç­‰å¾…æ‰€æœ‰èƒŒæ™¯ç¨‹åºå®Œæˆ\n    for pid in \"${pids[@]}\"; do\n        wait \"$pid\"\n    done\n    \n    echo \"  âœ… Concurrent lock test completed\"\n}\n\ntest_redis_performance() {\n    echo \"âš¡ Testing Redis performance...\"\n    \n    local start_time\n    local end_time\n    local duration\n    \n    start_time=$(date +%s%N)\n    \n    # åŸ·è¡Œå¤šå€‹å¿«é€Ÿçš„é–æ“ä½œ\n    for i in {1..10}; do\n        local test_key=\"perf-test-$i-$(date +%s)\"\n        curl -s -X POST \"$STAGING_APP_URL/api/test/locks/$test_key/acquire\" \\\n            -H \"Content-Type: application/json\" \\\n            -d '{\"waitTime\": 1, \"leaseTime\": 5, \"timeUnit\": \"SECONDS\"}' >/dev/null 2>&1\n        curl -s -X DELETE \"$STAGING_APP_URL/api/test/locks/$test_key\" >/dev/null 2>&1\n    done\n    \n    end_time=$(date +%s%N)\n    duration=$(( (end_time - start_time) / 1000000 ))  # è½‰æ›ç‚ºæ¯«ç§’\n    \n    echo \"  âœ… Performance test completed: 10 operations in ${duration}ms\"\n    \n    if [ \"$duration\" -lt 5000 ]; then\n        echo \"  âœ… Performance is acceptable (< 5 seconds)\"\n    else\n        echo \"  âš ï¸  Performance may need optimization (> 5 seconds)\"\n    fi\n}\n\ntest_redis_failover() {\n    echo \"ğŸ”„ Testing Redis failover resilience...\"\n    \n    # é€™å€‹æ¸¬è©¦ä¸»è¦æª¢æŸ¥æ‡‰ç”¨ç¨‹å¼åœ¨ Redis é€£ç·šå•é¡Œæ™‚çš„è¡Œç‚º\n    echo \"  Testing application resilience during potential Redis issues...\"\n    \n    # åŸ·è¡Œä¸€äº›æ“ä½œï¼Œçœ‹çœ‹æ‡‰ç”¨ç¨‹å¼æ˜¯å¦èƒ½æ­£å¸¸è™•ç† Redis ç›¸é—œçš„éŒ¯èª¤\n    local test_key=\"failover-test-$(date +%s)\"\n    \n    for i in {1..3}; do\n        echo \"    Attempt $i: Testing lock operation during potential failover...\"\n        \n        response=$(curl -s -w \"%{http_code}\" -X POST \"$STAGING_APP_URL/api/test/locks/$test_key/acquire\" \\\n            -H \"Content-Type: application/json\" \\\n            -d '{\"waitTime\": 2, \"leaseTime\": 10, \"timeUnit\": \"SECONDS\"}' || echo \"000\")\n        \n        http_code=\"${response: -3}\"\n        \n        if [[ \"$http_code\" =~ ^[2-3][0-9][0-9]$ ]]; then\n            echo \"    âœ… Attempt $i: Successful (HTTP $http_code)\"\n        else\n            echo \"    âš ï¸  Attempt $i: Failed (HTTP $http_code) - may indicate Redis issues\"\n        fi\n        \n        sleep 1\n    done\n    \n    echo \"  âœ… Failover resilience test completed\"\n}\n\n# ä¸»è¦æ¸¬è©¦åŸ·è¡Œ\necho \"ğŸš€ Starting Staging Redis Integration Tests...\"\necho \"================================================\"\n\n# åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦\ntests=(\n    \"test_redis_connectivity\"\n    \"test_distributed_locks\"\n    \"test_concurrent_locks\"\n    \"test_redis_performance\"\n    \"test_redis_failover\"\n)\n\nfailed_tests=()\n\nfor test in \"${tests[@]}\"; do\n    echo \"\"\n    if $test; then\n        echo \"âœ… $test PASSED\"\n    else\n        echo \"âŒ $test FAILED\"\n        failed_tests+=(\"$test\")\n    fi\n    echo \"------------------------------------------------\"\ndone\n\n# æ¸¬è©¦çµæœç¸½çµ\necho \"\"\necho \"ğŸ“Š Test Results Summary:\"\necho \"================================================\"\necho \"Total tests: ${#tests[@]}\"\necho \"Passed: $((${#tests[@]} - ${#failed_tests[@]}))\"\necho \"Failed: ${#failed_tests[@]}\"\n\nif [ ${#failed_tests[@]} -eq 0 ]; then\n    echo \"ğŸ‰ All Redis integration tests PASSED!\"\n    exit 0\nelse\n    echo \"âŒ Some tests FAILED:\"\n    for test in \"${failed_tests[@]}\"; do\n        echo \"  - $test\"\n    done\n    echo \"\"\n    echo \"ğŸ’¡ Note: Some failures may be expected if:\"\n    echo \"  - Test API endpoints are not implemented\"\n    echo \"  - Redis cluster is under maintenance\"\n    echo \"  - Network connectivity issues\"\n    exit 1\nfi\n"